<script>
  const TOTAL = 168;            // <-- DEVE essere giusto
  const FOLDER = "mp3";
  const SUFFIX = "_Chapter 0.mp3";

  const gate = document.getElementById("gate");
  const startBtn = document.getElementById("startBtn");
  const startImg = document.getElementById("startImg");
  const choice = document.getElementById("choice");

  const introPlayer = document.getElementById("introPlayer");

  const app = document.getElementById("app");
  const player = document.getElementById("player");

  let started = false;

  function pad3(n){ return String(n).padStart(3, "0"); }

  function pickRandomUrl(){
    const n = Math.floor(Math.random() * TOTAL) + 1;
    const file = `${pad3(n)}${SUFFIX}`;
    return `${FOLDER}/${encodeURIComponent(file)}`;
  }

  function hardStopIntro(){
    try { introPlayer.pause(); } catch(e) {}
    try { introPlayer.currentTime = 0; } catch(e) {}
    // “hard stop” (su certi mobile serve)
    try { introPlayer.removeAttribute("src"); } catch(e) {}
    try { introPlayer.load(); } catch(e) {}
  }

  async function loadAndPlayRandom(maxTries = 8){
    for (let i = 0; i < maxTries; i++){
      const url = pickRandomUrl();
      player.src = url;
      player.load();

      // aspetta un attimo che provi a caricare
      const ok = await new Promise((resolve) => {
        const t = setTimeout(() => resolve(false), 1200);

        player.oncanplay = () => { clearTimeout(t); resolve(true); };
        player.onerror   = () => { clearTimeout(t); resolve(false); };
      });

      if (ok){
        try { await player.play(); } catch(e) {}
        return;
      }
    }

    // Se dopo N tentativi non trova nulla:
    alert("Non trovo i file MP3 casuali. Controlla TOTAL e i nomi (es. 001_Chapter 0.mp3).");
  }

  // START: parte intro e mostra scelta
  startBtn.addEventListener("click", async () => {
    if (started) return;
    started = true;

    startBtn.style.display = "none";
    startImg.style.display = "block";
    choice.style.display = "flex";

    try {
      introPlayer.src = `${FOLDER}/inizio.mp3`;
      introPlayer.load();
      await introPlayer.play();
    } catch(e) {}
  });

  // Blu: ANSA (stop intro prima di andare via)
  document.getElementById("btnBlue").addEventListener("click", () => {
    hardStopIntro();
    window.location.href = "https://www.ansa.it/sito/notizie/topnews/index.shtml";
  });

  // Rosso: entra nel programma
  document.getElementById("btnRed").addEventListener("click", async () => {
    // STOP intro davvero
    hardStopIntro();

    // Mostra programma
    gate.style.display = "none";
    app.style.display = "flex";

    // Carica e avvia random (con retry se qualche file manca)
    await loadAndPlayRandom();
  });

  // Bottoni programma
  document.getElementById("btnPlay").addEventListener("click", async () => {
    try { await player.play(); } catch(e) {}
  });

  document.getElementById("btnNext").addEventListener("click", async () => {
    await loadAndPlayRandom();
  });
</script>
