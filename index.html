<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCHO • Random Jukebox</title>

  <style>
    :root{ --green:#00ff9a; --blue:#1f6fff; --red:#ff2d2d; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#000;color:#eafff6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{overflow:hidden}

    /* Background container */
    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 700px at 50% 70%, rgba(0,255,154,.10), transparent 60%),
        radial-gradient(900px 500px at 50% 40%, rgba(0,255,154,.08), transparent 60%),
        url("assets/matrix.jpg") center/cover no-repeat;
      filter:saturate(1.05) contrast(1.05);
      transform:scale(1.02);
    }
    .vignette{position:fixed; inset:-40px; background:radial-gradient(circle at 50% 55%, transparent 35%, rgba(0,0,0,.75) 78%); pointer-events:none;}
    .scanlines{position:fixed; inset:0; background:repeating-linear-gradient(to bottom, rgba(255,255,255,.02), rgba(255,255,255,.02) 1px, rgba(0,0,0,0) 3px, rgba(0,0,0,0) 6px); mix-blend-mode:overlay; opacity:.45; pointer-events:none;}

    .wrap{position:relative;height:100%;display:flex;align-items:center;justify-content:center;padding:18px;}
    .panel{
      width:min(980px,96vw); height:min(640px,92vh);
      border:1px solid rgba(0,255,154,.25);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      box-shadow:0 0 0 1px rgba(0,255,154,.12) inset, 0 25px 80px rgba(0,0,0,.6);
      position:relative; overflow:hidden;
    }

    .hud{
      position:absolute; left:16px; right:16px; top:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      pointer-events:none;
    }
    .brand{display:flex;flex-direction:column;gap:2px;}
    .brand b{letter-spacing:.22em;color:var(--green);text-shadow:0 0 12px rgba(0,255,154,.35);font-size:12px;}
    .brand span{font-size:12px;opacity:.8;}
    .status{font-size:12px;color:#bfffe7;opacity:.9;text-align:right;}
    .status .dot{display:inline-block;width:7px;height:7px;border-radius:99px;background:var(--green);box-shadow:0 0 10px rgba(0,255,154,.6);margin-right:8px;vertical-align:middle;}

    .screen{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:26px;}
    .hidden{display:none;}

    .card{
      width:min(720px,92%);
      background:rgba(0,0,0,.45);
      border:1px solid rgba(0,255,154,.20);
      border-radius:18px;
      padding:22px 20px;
      box-shadow:0 0 0 1px rgba(0,255,154,.08) inset;
      backdrop-filter:blur(8px);
      text-align:center;
    }
    .title{margin:0 0 10px;font-size:22px;letter-spacing:.06em;text-shadow:0 0 18px rgba(0,255,154,.22);}
    .subtitle{margin:0 0 14px;font-size:13px;line-height:1.45;opacity:.9;}
    .controls{margin-top:14px;display:flex;gap:14px;justify-content:center;flex-wrap:wrap;}

    .btn{
      appearance:none;border:1px solid rgba(255,255,255,.14);
      border-radius:16px;background:rgba(0,0,0,.55);color:#fff;
      padding:12px 16px;cursor:pointer;font-weight:900;letter-spacing:.06em;text-transform:uppercase;
      transition:transform .12s ease;
      -webkit-tap-highlight-color:transparent;
      display:flex;align-items:center;justify-content:center;gap:10px;
    }
    .btn:active{transform:translateY(1px) scale(.99);}
    .btn.blue{border-color:rgba(31,111,255,.35);}
    .btn.red{border-color:rgba(255,45,45,.35);}
    .btn.green{border-color:rgba(0,255,154,.30);}

    .pill{
      width:22px;height:12px;border-radius:999px;position:relative;display:inline-block;
      border:1px solid rgba(255,255,255,.18);overflow:hidden;
    }
    .pill:before,.pill:after{content:"";position:absolute;inset:0;width:50%;opacity:.95;}
    .pill:after{left:50%;}
    .pill.blue:before{background:rgba(31,111,255,.95);} .pill.blue:after{background:rgba(0,0,0,.25);}
    .pill.red:before{background:rgba(255,45,45,.95);}   .pill.red:after{background:rgba(0,0,0,.25);}

    .menuGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:12px;}
    .menuBtn{
      border:1px solid rgba(0,255,154,.18);
      background:rgba(0,0,0,.40);
      color:#dfffee;border-radius:16px;padding:14px 12px;
      cursor:pointer;font-weight:900;letter-spacing:.06em;text-transform:uppercase;
    }
    .menuBtn:active{transform:translateY(1px) scale(.99);}

    .playerbar{
      position:absolute; left:16px; right:16px; bottom:16px;
      border-radius:14px; border:1px solid rgba(0,255,154,.18);
      background:rgba(0,0,0,.38);
      padding:10px 12px;
      backdrop-filter:blur(8px);
      display:none;
    }
    .playerbar.on{display:block;}
    .track{font-size:12px;opacity:.9;margin-bottom:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    audio,video{width:100%;}
    video{max-height:240px;}
    .row{display:flex;justify-content:center;margin-top:12px;}
    .ghost{border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.28);color:#dfffee;border-radius:14px;padding:10px 12px;cursor:pointer;font-weight:900;}

    @media (max-width:640px){
      .menuGrid{grid-template-columns:1fr;}
      video{max-height:200px;}
    }
  </style>
</head>

<body>
  <div class="bg" id="bg"></div>
  <div class="vignette"></div>
  <div class="scanlines"></div>

  <div class="wrap">
    <div class="panel">
      <div class="hud">
        <div class="brand"><b>O C H O</b><span>Random Jukebox</span></div>
        <div class="status"><span class="dot"></span><span id="statusText">In attesa…</span></div>
      </div>

      <!-- SCREEN: TOCCA PER ENTRARE -->
      <div class="screen" id="screenEnter">
        <div class="card">
          <h1 class="title">TOCCA PER ENTRARE</h1>
          <p class="subtitle">Toccando parte <b>inizio.mp3</b>.</p>
          <div class="controls">
            <button class="btn green" id="enterBtn">TOCCA</button>
          </div>
        </div>
      </div>

      <!-- SCREEN: PILLs (sfondo inizio.jpeg) -->
      <div class="screen hidden" id="screenPills">
        <div class="card">
          <h1 class="title">SCEGLI LA PILLOLA</h1>
          <p class="subtitle">Blu: apri ANSA. Rossa: entra nel menu.</p>
          <div class="controls">
            <button class="btn blue" id="blueBtn"><span class="pill blue"></span>Pillola blu</button>
            <button class="btn red" id="redBtn"><span class="pill red"></span>Pillola rossa</button>
          </div>
        </div>
      </div>

      <!-- SCREEN: RED MENU -->
      <div class="screen hidden" id="screenMenu">
        <div class="card">
          <h1 class="title">MENU</h1>
          <p class="subtitle">Random senza ripetizioni.</p>

          <div class="menuGrid">
            <button class="menuBtn" data-cat="frasi">FRASI</button>
            <button class="menuBtn" data-cat="song">SONG</button>
            <button class="menuBtn" data-cat="broadcast">BROADCAST</button>
            <button class="menuBtn" data-cat="video">VIDEO</button>
          </div>

          <div class="row">
            <button class="ghost" id="backToPills">⟵ Torna alle pillole</button>
          </div>
        </div>
      </div>

      <!-- PLAYER -->
      <div class="playerbar" id="playerbar">
        <div class="track" id="track">—</div>
        <audio id="audio" controls></audio>
        <video id="video" controls class="hidden"></video>
      </div>

      <!-- AUDIO INTRO -->
      <audio id="introAudio" preload="auto" src="mp3/inizio.mp3"></audio>
    </div>
  </div>

<script>
/* =======================
   CONFIG GITHUB
   ======================= */
const GITHUB_USER = "fabriziodadamo72-source";
const GITHUB_REPO = "jukebox-random";
const GITHUB_BRANCH = "main"; // o "master" se usi master

const ANSA_URL = "https://www.ansa.it/";

// Configurazione cartelle e estensioni
const FOLDERS = {
  frasi: { path: "mp3", exts: [".mp3"], exclude: ["inizio.mp3"] },
  song: { path: "mp3", exts: [".mp3"], exclude: ["inizio.mp3"] },
  broadcast: { path: "broadcast", exts: [".mp3"] },
  video: { path: "mp4", exts: [".mp4", ".avi", ".mov", ".webm"] }
};

/* =======================
   STATE
   ======================= */
const playlists = new Map();
const decks = new Map();
const deckPos = new Map();
let currentCat = "frasi";

/* =======================
   ELEMENTS
   ======================= */
const bg = document.getElementById("bg");
const statusText = document.getElementById("statusText");

const screenEnter = document.getElementById("screenEnter");
const screenPills = document.getElementById("screenPills");
const screenMenu = document.getElementById("screenMenu");

const introAudio = document.getElementById("introAudio");

const playerbar = document.getElementById("playerbar");
const trackEl = document.getElementById("track");
const audio = document.getElementById("audio");
const video = document.getElementById("video");

/* =======================
   HELPERS
   ======================= */
function setStatus(msg){ statusText.textContent = msg; }
function show(which){
  screenEnter.classList.toggle("hidden", which !== "enter");
  screenPills.classList.toggle("hidden", which !== "pills");
  screenMenu.classList.toggle("hidden", which !== "menu");
}
function showPlayer(on){ playerbar.classList.toggle("on", !!on); }

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function prettyName(path){
  const name = (path||"").split("/").pop() || "Contenuto";
  return decodeURIComponent(name);
}

/* =======================
   GITHUB API
   ======================= */
async function fetchGitHubFolder(folderPath){
  const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${folderPath}?ref=${GITHUB_BRANCH}`;
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error(`GitHub API error: ${res.status}`);
    const data = await res.json();
    return data.filter(item => item.type === "file").map(item => item.name);
  }catch(e){
    console.error("Errore fetch GitHub:", e);
    return [];
  }
}

async function loadCat(cat){
  if(playlists.has(cat)) return true;
  
  setStatus(`Caricamento ${cat}...`);
  const config = FOLDERS[cat];
  if(!config){
    console.error("Categoria sconosciuta:", cat);
    return false;
  }

  const allFiles = await fetchGitHubFolder(config.path);
  
  // Filtra per estensione e escludi file specifici
  let files = allFiles.filter(name => {
    const lower = name.toLowerCase();
    const hasExt = config.exts.some(ext => lower.endsWith(ext));
    const isExcluded = (config.exclude || []).some(ex => name === ex);
    return hasExt && !isExcluded;
  });

  if(!files.length){
    setStatus(`Nessun file in ${cat}`);
    trackEl.textContent = `ERRORE: Nessun file trovato in ${config.path}/`;
    showPlayer(true);
    return false;
  }

  // Costruisci percorsi completi
  files = files.map(f => `${config.path}/${f}`);

  playlists.set(cat, files);
  decks.set(cat, shuffle([...Array(files.length).keys()]));
  deckPos.set(cat, 0);
  
  console.log(`✅ ${cat}: ${files.length} file caricati`);
  return true;
}

function resetDeck(cat){
  const n = (playlists.get(cat) || []).length;
  decks.set(cat, shuffle([...Array(n).keys()]));
  deckPos.set(cat, 0);
}

function draw(cat){
  const list = playlists.get(cat) || [];
  if(!list.length) return -1;
  if(!decks.has(cat) || !deckPos.has(cat)) resetDeck(cat);

  let p = deckPos.get(cat);
  const d = decks.get(cat);
  if(p >= d.length){ resetDeck(cat); p = 0; }
  const idx = decks.get(cat)[p];
  deckPos.set(cat, p + 1);
  return idx;
}

function playPath(cat, src){
  currentCat = cat;
  showPlayer(true);
  trackEl.textContent = `[${cat.toUpperCase()}] ${prettyName(src)}`;
  setStatus("In riproduzione…");

  if(cat === "video"){
    audio.pause(); audio.classList.add("hidden");
    video.classList.remove("hidden");
    video.src = src;
    video.play().catch(()=>{});
  }else{
    video.pause(); video.classList.add("hidden");
    audio.classList.remove("hidden");
    audio.src = src;
    audio.play().catch(()=>{});
  }
}

async function playNext(cat){
  const ok = await loadCat(cat);
  if(!ok) return;
  const idx = draw(cat);
  const src = playlists.get(cat)[idx];
  playPath(cat, src);
}

/* =======================
   EVENTS
   ======================= */

document.getElementById("enterBtn").addEventListener("click", ()=>{
  setStatus("Avvio…");
  introAudio.currentTime = 0;
  introAudio.play().catch(()=>{});
  bg.style.backgroundImage =
    `radial-gradient(1200px 700px at 50% 70%, rgba(0,255,154,.10), transparent 60%),
     radial-gradient(900px 500px at 50% 40%, rgba(0,255,154,.08), transparent 60%),
     url("assets/inizio.jpeg") center/cover no-repeat`;
  show("pills");
  setStatus("Pronto.");
});

document.getElementById("blueBtn").addEventListener("click", ()=>{
  window.open(ANSA_URL, "_blank", "noopener,noreferrer");
});

document.getElementById("redBtn").addEventListener("click", ()=>{
  show("menu");
  setStatus("Menu.");
});

document.getElementById("backToPills").addEventListener("click", ()=>{
  show("pills");
  setStatus("Pronto.");
});

document.querySelectorAll(".menuBtn").forEach(b=>{
  b.addEventListener("click", ()=> playNext(b.dataset.cat));
});

audio.addEventListener("ended", ()=> playNext(currentCat));
video.addEventListener("ended", ()=> playNext(currentCat));

/* BOOT */
show("enter");
setStatus("In attesa…");
</script>
</body>
</html>
