<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OCHO • Random Jukebox</title>

<style>
  :root{
    --green:#00ff9a; --blue:#1f6fff; --red:#ff2d2d;
  }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; background:#000; color:#eafff6; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  body{overflow:hidden}

  .bg{
    position:fixed; inset:0;
    background:
      radial-gradient(1200px 700px at 50% 70%, rgba(0,255,154,.10), transparent 60%),
      radial-gradient(900px 500px at 50% 40%, rgba(0,255,154,.08), transparent 60%),
      url("matrix.jpg") center/cover no-repeat;
    filter:saturate(1.05) contrast(1.05);
    transform:scale(1.02);
  }
  .vignette{position:fixed; inset:-40px; background:radial-gradient(circle at 50% 55%, transparent 35%, rgba(0,0,0,.75) 78%); pointer-events:none;}
  .scanlines{position:fixed; inset:0; background:repeating-linear-gradient(to bottom, rgba(255,255,255,.02), rgba(255,255,255,.02) 1px, rgba(0,0,0,0) 3px, rgba(0,0,0,0) 6px); mix-blend-mode:overlay; opacity:.45; pointer-events:none;}

  .wrap{position:relative; height:100%; display:flex; align-items:center; justify-content:center; padding:18px;}
  .panel{
    width:min(980px,96vw); height:min(640px,92vh);
    border:1px solid rgba(0,255,154,.25);
    border-radius:18px;
    background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
    box-shadow:0 0 0 1px rgba(0,255,154,.12) inset, 0 25px 80px rgba(0,0,0,.6);
    position:relative; overflow:hidden;
  }

  .hud{
    position:absolute; left:16px; right:16px; top:14px;
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    pointer-events:none;
  }
  .brand{display:flex; flex-direction:column; gap:2px;}
  .brand b{letter-spacing:.22em; color:var(--green); text-shadow:0 0 12px rgba(0,255,154,.35); font-size:12px;}
  .brand span{font-size:12px; opacity:.8;}
  .status{font-size:12px; color:#bfffe7; opacity:.9; text-align:right;}
  .status .dot{display:inline-block; width:7px; height:7px; border-radius:99px; background:var(--green); box-shadow:0 0 10px rgba(0,255,154,.6); margin-right:8px; vertical-align:middle;}

  .screen{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; padding:26px; transition:opacity .18s ease, transform .18s ease;}
  .screen.hidden{opacity:0; transform:scale(.98); pointer-events:none;}
  .card{
    width:min(720px,92%);
    background:rgba(0,0,0,.40);
    border:1px solid rgba(0,255,154,.20);
    border-radius:18px;
    padding:22px 20px;
    box-shadow:0 0 0 1px rgba(0,255,154,.08) inset;
    backdrop-filter:blur(8px);
    text-align:center;
  }
  .title{margin:0 0 10px; font-size:22px; letter-spacing:.06em; text-shadow:0 0 18px rgba(0,255,154,.22);}
  .subtitle{margin:0 0 14px; font-size:13px; line-height:1.45; opacity:.9;}
  .quote{margin:0; font-size:12px; opacity:.8; color:#baf8de;}

  .controls{
    margin-top:16px;
    display:flex; gap:14px; justify-content:center; flex-wrap:wrap;
  }
  .btn{
    appearance:none; border:1px solid rgba(255,255,255,.14);
    border-radius:16px; background:rgba(0,0,0,.55); color:#fff;
    padding:12px 16px; cursor:pointer; font-weight:800; letter-spacing:.06em; text-transform:uppercase;
    transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
  }
  .btn:active{transform:translateY(1px) scale(.99);}
  .btn.blue{border-color:rgba(31,111,255,.35); box-shadow:0 0 18px rgba(31,111,255,.12);}
  .btn.red{border-color:rgba(255,45,45,.35); box-shadow:0 0 18px rgba(255,45,45,.12);}
  .btn.green{border-color:rgba(0,255,154,.30); box-shadow:0 0 18px rgba(0,255,154,.10);}

  .pill{
    width:22px;height:12px;border-radius:999px; display:inline-block; vertical-align:middle;
    border:1px solid rgba(255,255,255,.18); overflow:hidden; margin-right:10px;
    position:relative;
  }
  .pill:before,.pill:after{content:""; position:absolute; inset:0; width:50%; opacity:.95;}
  .pill:after{left:50%;}
  .pill.blue:before{background:rgba(31,111,255,.95);} .pill.blue:after{background:rgba(0,0,0,.25);}
  .pill.red:before{background:rgba(255,45,45,.95);}   .pill.red:after{background:rgba(0,0,0,.25);}

  .menuGrid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; margin-top:14px;}
  .menuBtn{
    border:1px solid rgba(0,255,154,.18);
    background:rgba(0,0,0,.40);
    color:#dfffee;
    border-radius:16px;
    padding:14px 12px;
    cursor:pointer;
    font-weight:900;
    letter-spacing:.06em;
    text-transform:uppercase;
  }
  .menuBtn:active{transform:translateY(1px) scale(.99);}

  .playerbar{
    position:absolute; left:16px; right:16px; bottom:16px;
    border-radius:14px; border:1px solid rgba(0,255,154,.18);
    background:rgba(0,0,0,.38);
    padding:10px 12px;
    backdrop-filter:blur(8px);
    opacity:0; transform:translateY(8px);
    transition:opacity .18s ease, transform .18s ease;
    pointer-events:none;
  }
  .playerbar.on{opacity:1; transform:translateY(0);}
  .track{font-size:12px; opacity:.9; margin-bottom:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  audio,video{width:100%; pointer-events:auto;}
  video{max-height:240px;}

  .row{display:flex; justify-content:center; margin-top:12px;}
  .ghost{border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.28); color:#dfffee; border-radius:14px; padding:10px 12px; cursor:pointer; font-weight:800;}

  .redmode{
    position:absolute; inset:0;
    background:radial-gradient(1000px 700px at 50% 70%, rgba(255,45,45,.10), transparent 60%), rgba(0,0,0,.18);
    opacity:0; transition:opacity .22s ease; pointer-events:none;
  }
  .redmode.on{opacity:1;}

  @media (max-width:640px){
    .menuGrid{grid-template-columns:1fr;}
    video{max-height:200px;}
  }
</style>
</head>

<body>
<div class="bg"></div>
<div class="vignette"></div>
<div class="scanlines"></div>

<div class="wrap">
  <div class="panel">
    <div class="redmode" id="redmode"></div>

    <div class="hud">
      <div class="brand"><b>O C H O</b><span>Random Jukebox</span></div>
      <div class="status"><span class="dot"></span><span id="statusText">In attesa…</span></div>
    </div>

    <!-- SCREEN 0: INTRO (TOCCA PER ENTRARE) -->
    <div class="screen" id="screenIntro">
      <div class="card">
        <h1 class="title">TOCCA PER ENTRARE</h1>
        <p class="subtitle">Avvia <b>inizio.mp3</b> e poi scegli la pillola.</p>
        <div class="controls">
          <button class="btn green" id="enterBtn">TOCCA</button>
        </div>
      </div>
    </div>

    <!-- SCREEN 1: PILLS -->
    <div class="screen hidden" id="screenHome">
      <div class="card">
        <h1 class="title">Scegli la pillola.</h1>
        <p class="subtitle">Blu: ascolta. Rossa: entra nel menu.</p>
        <p class="quote">“Pillola blu: fine della storia. Pillola rossa: resti nel Paese delle Meraviglie.”</p>

        <div class="controls">
          <button class="btn blue" id="blueBtn"><span class="pill blue"></span>Pillola blu</button>
          <button class="btn red" id="redBtn"><span class="pill red"></span>Pillola rossa</button>
        </div>
      </div>
    </div>

    <!-- SCREEN 2: RED MENU -->
    <div class="screen hidden" id="screenRedMenu">
      <div class="card">
        <h1 class="title">Paese delle Meraviglie</h1>
        <p class="subtitle">Random senza ripetizioni (prima li fa tutti, poi rimescola).</p>

        <div class="menuGrid">
          <!-- NOTA: mp3 = FRASI (solo etichetta) -->
          <button class="menuBtn" data-cat="mp3" type="button">FRASI</button>
          <button class="menuBtn" data-cat="song" type="button">SONG</button>
          <button class="menuBtn" data-cat="broadcast" type="button">BROADCAST</button>
          <button class="menuBtn" data-cat="video" type="button">VIDEO</button>
        </div>

        <div class="row">
          <button class="ghost" id="backHome" type="button">⟵ Torna alle pillole</button>
        </div>
      </div>
    </div>

    <!-- PLAYER -->
    <div class="playerbar" id="playerbar">
      <div class="track" id="track">—</div>
      <audio id="audio" controls></audio>
      <video id="video" controls class="hidden"></video>
    </div>

    <!-- INTRO AUDIO -->
    <audio id="introAudio" preload="auto" src="inizio.mp3"></audio>
  </div>
</div>

<script>
/* =========================================================
   CONFIG
   - questi JSON li gestisci tu aggiornandoli quando aggiungi file
   ========================================================= */
const SOURCES = {
  mp3: "content/mp3.json",             // FRASI (mp3)
  song: "content/song.json",           // SONG (mp3)
  broadcast: "content/broadcast.json", // BROADCAST (mp3)
  video: "content/video.json"          // VIDEO (mp4)
};

// prefissi automatici: se nel JSON metti solo "file.mp3", li completa lui
const PREFIX = {
  mp3: "media/mp3/",
  song: "media/song/",
  broadcast: "media/broadcast/",
  video: "media/video/"
};

/* =========================================================
   STATE
   ========================================================= */
const playlists = new Map(); // cat -> [paths...]
const decks = new Map();     // cat -> [indices shuffled]
const deckPos = new Map();   // cat -> position
let currentCategory = "mp3";

/* =========================================================
   ELEMENTS
   ========================================================= */
const statusText = document.getElementById("statusText");
const redmode = document.getElementById("redmode");

const screenIntro = document.getElementById("screenIntro");
const screenHome = document.getElementById("screenHome");
const screenRedMenu = document.getElementById("screenRedMenu");

const playerbar = document.getElementById("playerbar");
const trackEl = document.getElementById("track");
const audio = document.getElementById("audio");
const video = document.getElementById("video");
const introAudio = document.getElementById("introAudio");

/* =========================================================
   HELPERS
   ========================================================= */
function setStatus(msg){ statusText.textContent = msg; }
function showPlayer(on){ playerbar.classList.toggle("on", !!on); }

function showScreen(which){
  // which: intro | home | red
  screenIntro.classList.toggle("hidden", which !== "intro");
  screenHome.classList.toggle("hidden", which !== "home");
  screenRedMenu.classList.toggle("hidden", which !== "red");
}

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function prettyName(path){
  const name = (path || "").split("/").pop() || "Contenuto";
  return decodeURIComponent(name);
}

async function loadCategory(cat){
  if(playlists.has(cat)) return true;

  const url = SOURCES[cat];
  if(!url){
    setStatus("Categoria sconosciuta.");
    console.error("Categoria sconosciuta:", cat);
    return false;
  }

  try{
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("JSON non trovato: " + url);

    const data = await res.json();
    let files = Array.isArray(data) ? data : (data.files || []);
    files = files.filter(Boolean);

    if(!files.length) throw new Error("Lista vuota: " + url);

    // normalizza percorsi: se manca "/" assumo che sia solo nome file e metto prefisso
    files = files.map(f=>{
      if(f.includes("/")) return f;
      return (PREFIX[cat] || "") + f;
    });

    playlists.set(cat, files);

    // deck anti-ripetizione
    const idxs = [...Array(files.length).keys()];
    decks.set(cat, shuffle(idxs));
    deckPos.set(cat, 0);

    return true;
  }catch(e){
    console.error(e);
    setStatus("Errore contenuti ("+cat+").");
    trackEl.textContent = "ERRORE: " + (SOURCES[cat] || "sorgente") + " mancante/vuoto";
    showPlayer(true);
    return false;
  }
}

function resetDeck(cat){
  const files = playlists.get(cat) || [];
  const idxs = [...Array(files.length).keys()];
  decks.set(cat, shuffle(idxs));
  deckPos.set(cat, 0);
}

function drawNextIndex(cat){
  const files = playlists.get(cat) || [];
  if(!files.length) return -1;

  if(!decks.has(cat) || !deckPos.has(cat)) resetDeck(cat);

  let p = deckPos.get(cat);
  const deck = decks.get(cat);

  if(p >= deck.length){
    resetDeck(cat);
    p = 0;
  }

  const idx = decks.get(cat)[p];
  deckPos.set(cat, p + 1);
  return idx;
}

function playPath(cat, src){
  currentCategory = cat;
  const label = (cat === "mp3") ? "FRASI" : cat.toUpperCase();
  trackEl.textContent = `[${label}] ${prettyName(src)}`;
  showPlayer(true);

  // switch audio/video
  if(cat === "video"){
    audio.pause(); audio.classList.add("hidden");
    video.classList.remove("hidden");
    video.src = src;
    video.play().catch(()=>{});
  }else{
    video.pause(); video.classList.add("hidden");
    audio.classList.remove("hidden");
    audio.src = src;
    audio.play().catch(()=>{});
  }

  setStatus("In riproduzione…");
}

async function playNext(cat){
  const ok = await loadCategory(cat);
  if(!ok) return;

  const idx = drawNextIndex(cat);
  const files = playlists.get(cat);
  const src = files[idx];
  playPath(cat, src);
}

/* =========================================================
   EVENTS
   ========================================================= */

// 0) TOCCA PER ENTRARE
document.getElementById("enterBtn").addEventListener("click", async ()=>{
  setStatus("Avvio…");
  // parte inizio.mp3
  introAudio.currentTime = 0;
  introAudio.play().catch(()=>{});
  // mostra pillole
  showScreen("home");
  setStatus("Pronto.");
});

// 1) Pillola blu -> FRASI (mp3)
document.getElementById("blueBtn").addEventListener("click", async ()=>{
  redmode.classList.remove("on");
  await playNext("mp3");
});

// 2) Pillola rossa -> menu
document.getElementById("redBtn").addEventListener("click", ()=>{
  redmode.classList.add("on");
  showScreen("red");
  setStatus("Menu rosso.");
});

// 3) Torna alle pillole
document.getElementById("backHome").addEventListener("click", ()=>{
  showScreen("home");
  setStatus("Pronto.");
});

// 4) Bottoni menu categorie (FRASI/SONG/BROADCAST/VIDEO)
document.querySelectorAll(".menuBtn").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    const cat = btn.getAttribute("data-cat");
    await playNext(cat);
  });
});

// autoplay continuo
audio.addEventListener("ended", ()=> playNext(currentCategory));
video.addEventListener("ended", ()=> playNext(currentCategory));

/* Boot */
setStatus("In attesa…");
showScreen("intro");
</script>
</body>
</html>
