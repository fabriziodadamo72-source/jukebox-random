<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCHO ‚Ä¢ Enhanced Jukebox</title>

  <style>
    :root{ 
      --green:#00ff9a; 
      --blue:#1f6fff; 
      --red:#ff2d2d;
      --dark:#0a0e0d;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--dark);color:#eafff6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{overflow:hidden}

    /* Matrix Rain Background */
    #matrixCanvas{
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      opacity:0.15;
      pointer-events:none;
      z-index:1;
    }

    /* Background container */
    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 700px at 50% 70%, rgba(0,255,154,.12), transparent 60%),
        radial-gradient(900px 500px at 50% 40%, rgba(0,255,154,.10), transparent 60%),
        url("assets/matrix.jpg") center/cover no-repeat;
      filter:saturate(1.1) contrast(1.08);
      transform:scale(1.02);
      z-index:2;
    }
    .vignette{
      position:fixed; 
      inset:-40px; 
      background:radial-gradient(circle at 50% 55%, transparent 35%, rgba(0,0,0,.8) 78%); 
      pointer-events:none;
      z-index:3;
    }
    .scanlines{
      position:fixed; 
      inset:0; 
      background:repeating-linear-gradient(to bottom, rgba(255,255,255,.02), rgba(255,255,255,.02) 1px, rgba(0,0,0,0) 3px, rgba(0,0,0,0) 6px); 
      mix-blend-mode:overlay; 
      opacity:.45; 
      pointer-events:none;
      z-index:4;
      animation:scan 8s linear infinite;
    }
    @keyframes scan{
      0%{transform:translateY(0)}
      100%{transform:translateY(10px)}
    }

    /* Floating particles */
    .particles{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:3;
    }
    .particle{
      position:absolute;
      width:3px;
      height:3px;
      background:var(--green);
      border-radius:50%;
      opacity:0;
      animation:float 15s infinite;
      box-shadow:0 0 10px var(--green);
    }
    @keyframes float{
      0%{opacity:0;transform:translateY(100vh) translateX(0)}
      10%{opacity:0.6}
      90%{opacity:0.3}
      100%{opacity:0;transform:translateY(-20vh) translateX(100px)}
    }

    .wrap{
      position:relative;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:10;
    }
    .panel{
      width:min(980px,96vw); 
      height:min(640px,92vh);
      border:1px solid rgba(0,255,154,.35);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.45));
      box-shadow:
        0 0 0 1px rgba(0,255,154,.15) inset, 
        0 0 40px rgba(0,255,154,.2),
        0 25px 80px rgba(0,0,0,.7);
      position:relative; 
      overflow:hidden;
      animation:panelGlow 3s ease-in-out infinite;
    }
    @keyframes panelGlow{
      0%, 100%{box-shadow:0 0 0 1px rgba(0,255,154,.15) inset, 0 0 40px rgba(0,255,154,.2), 0 25px 80px rgba(0,0,0,.7);}
      50%{box-shadow:0 0 0 1px rgba(0,255,154,.25) inset, 0 0 60px rgba(0,255,154,.3), 0 25px 80px rgba(0,0,0,.7);}
    }

    .hud{
      position:absolute; 
      left:16px; 
      right:16px; 
      top:14px;
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:12px;
      pointer-events:none;
      z-index:20;
    }
    .brand{display:flex;flex-direction:column;gap:2px;}
    .brand b{
      letter-spacing:.30em;
      color:var(--green);
      text-shadow:0 0 15px rgba(0,255,154,.5), 0 0 30px rgba(0,255,154,.3);
      font-size:14px;
      animation:glitch 5s infinite;
    }
    @keyframes glitch{
      0%, 90%, 100%{transform:translate(0)}
      91%{transform:translate(-2px, 1px)}
      92%{transform:translate(2px, -1px)}
      93%{transform:translate(0)}
    }

    .status{
      font-size:12px;
      color:#bfffe7;
      opacity:.9;
      text-align:right;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .status .dot{
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--green);
      box-shadow:0 0 12px rgba(0,255,154,.8);
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{opacity:1;transform:scale(1)}
      50%{opacity:0.6;transform:scale(0.9)}
    }

    .screen{
      position:absolute; 
      inset:0; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      padding:26px;
      opacity:0;
      transition:opacity 0.4s ease;
    }
    .screen.active{opacity:1;}
    .hidden{display:none;}
    
    /* Schermata Oracle sopra il portale - DEVE essere FIXED! */
    #screenOracle{
      position:fixed !important;
      inset:0;
      z-index:1002;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:26px;
    }

    .card{
      width:min(720px,92%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(0,255,154,.25);
      border-radius:18px;
      padding:26px 24px;
      box-shadow:
        0 0 0 1px rgba(0,255,154,.12) inset,
        0 10px 40px rgba(0,0,0,.5);
      backdrop-filter:blur(10px);
      text-align:center;
      transform:scale(0.95);
      transition:transform 0.4s ease;
    }
    .screen.active .card{transform:scale(1);}

    .title{
      margin:0 0 10px;
      font-size:26px;
      letter-spacing:.08em;
      text-shadow:0 0 20px rgba(0,255,154,.3);
      background:linear-gradient(135deg, #fff, var(--green));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .subtitle{margin:0 0 14px;font-size:13px;line-height:1.45;opacity:.9;}
    .controls{margin-top:18px;display:flex;gap:14px;justify-content:center;flex-wrap:wrap;}

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      border-radius:16px;
      background:rgba(0,0,0,.6);
      color:#fff;
      padding:14px 20px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      transition:all .2s ease;
      -webkit-tap-highlight-color:transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      position:relative;
      overflow:hidden;
    }
    .btn:before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg, transparent, rgba(255,255,255,.1), transparent);
      transform:translateX(-100%);
      transition:transform 0.6s;
    }
    .btn:hover:before{transform:translateX(100%);}
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 5px 20px rgba(0,255,154,.3);
    }
    .btn:active{transform:translateY(0) scale(.98);}
    .btn.blue{border-color:rgba(31,111,255,.4); box-shadow:0 0 15px rgba(31,111,255,.2);}
    .btn.blue:hover{box-shadow:0 5px 25px rgba(31,111,255,.4);}
    .btn.red{border-color:rgba(255,45,45,.4); box-shadow:0 0 15px rgba(255,45,45,.2);}
    .btn.red:hover{box-shadow:0 5px 25px rgba(255,45,45,.4);}
    .btn.green{border-color:rgba(0,255,154,.35); box-shadow:0 0 15px rgba(0,255,154,.2);}
    .btn.green:hover{box-shadow:0 5px 25px rgba(0,255,154,.4);}

    .pill{
      width:24px;
      height:14px;
      border-radius:999px;
      position:relative;
      display:inline-block;
      border:1px solid rgba(255,255,255,.2);
      overflow:hidden;
    }
    .pill:before,.pill:after{content:"";position:absolute;inset:0;width:50%;opacity:.95;}
    .pill:after{left:50%;}
    .pill.blue:before{background:rgba(31,111,255,.95);} 
    .pill.blue:after{background:rgba(0,0,0,.3);}
    .pill.red:before{background:rgba(255,45,45,.95);}   
    .pill.red:after{background:rgba(0,0,0,.3);}

    .menuGrid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:14px;
      margin-top:16px;
    }
    .menuBtn{
      border:1px solid rgba(0,255,154,.22);
      background:rgba(0,0,0,.45);
      color:#dfffee;
      border-radius:16px;
      padding:18px 14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      transition:all 0.3s ease;
      position:relative;
      overflow:hidden;
    }
    .menuBtn:before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg, transparent, rgba(0,255,154,.1), transparent);
      transform:translateX(-100%);
      transition:transform 0.6s;
    }
    .menuBtn:hover:before{transform:translateX(100%);}
    .menuBtn:hover{
      transform:translateY(-3px);
      border-color:rgba(0,255,154,.4);
      box-shadow:0 8px 25px rgba(0,255,154,.25);
    }
    .menuBtn:active{transform:translateY(0) scale(.98);}
    .menuBtn .btnCaption{
      font-size:10px;
      font-weight:400;
      letter-spacing:.04em;
      text-transform:none;
      opacity:.7;
      line-height:1.3;
      max-width:90%;
    }
    .menuBtn .newBadge{
      position:absolute;
      top:8px;
      right:8px;
      background:var(--red);
      color:#fff;
      font-size:9px;
      padding:3px 6px;
      border-radius:8px;
      font-weight:900;
      box-shadow:0 0 10px rgba(255,45,45,.6);
      animation:badgePulse 2s infinite;
    }
    @keyframes badgePulse{
      0%, 100%{transform:scale(1)}
      50%{transform:scale(1.1)}
    }

    .playerbar{
      position:absolute; 
      left:16px; 
      right:16px; 
      bottom:16px;
      border-radius:16px; 
      border:1px solid rgba(0,255,154,.25);
      background:rgba(0,0,0,.5);
      padding:14px 16px;
      backdrop-filter:blur(12px);
      box-shadow:0 0 30px rgba(0,0,0,.6), 0 0 0 1px rgba(0,255,154,.15) inset;
      display:none;
      z-index:30;
    }
    .playerbar.on{display:block;}
    
    .track{
      font-size:13px;
      font-weight:700;
      opacity:.95;
      margin-bottom:10px;
      text-align:center;
      letter-spacing:.06em;
      color:var(--green);
      text-shadow:0 0 10px rgba(0,255,154,.4);
    }
    .progress-info{
      display:flex;
      justify-content:center;
      font-size:11px;
      opacity:.75;
      margin-bottom:8px;
    }
    
    audio,video{width:100%;margin:10px 0;}
    video{max-height:240px;border-radius:8px;}
    
    .player-controls{
      display:flex;
      gap:8px;
      justify-content:center;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .player-controls button{
      border:1px solid rgba(255,255,255,.2);
      background:rgba(0,0,0,.4);
      color:#dfffee;
      border-radius:12px;
      padding:8px 14px;
      cursor:pointer;
      font-weight:700;
      font-size:11px;
      transition:all 0.2s;
      text-transform:uppercase;
      letter-spacing:.05em;
    }
    .player-controls button:hover{
      background:rgba(0,255,154,.2);
      border-color:rgba(0,255,154,.4);
      transform:translateY(-1px);
    }
    .player-controls button.active{
      background:rgba(0,255,154,.3);
      border-color:var(--green);
    }

    .row{display:flex;justify-content:center;margin-top:14px;}
    .ghost{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35);
      color:#dfffee;
      border-radius:14px;
      padding:10px 16px;
      cursor:pointer;
      font-weight:700;
      transition:all 0.2s;
    }
    .ghost:hover{
      background:rgba(255,255,255,.1);
      transform:translateY(-2px);
    }

    .stopBtn{
      border:1px solid rgba(255,45,45,.4);
      background:rgba(0,0,0,.6);
      color:#ff2d2d;
      border-radius:12px;
      padding:10px 16px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      margin-top:10px;
      width:100%;
      transition:all 0.2s;
    }
    .stopBtn:hover{
      background:rgba(255,45,45,.2);
      border-color:var(--red);
      box-shadow:0 0 20px rgba(255,45,45,.3);
    }
    .stopBtn:active{transform:scale(.98);}

    /* Playing indicator */
    .playing-indicator{
      display:none;
      align-items:center;
      gap:4px;
      margin-left:8px;
    }
    .playing-indicator.active{display:inline-flex;}
    .bar{
      width:3px;
      height:12px;
      background:var(--green);
      animation:soundbar 0.8s ease-in-out infinite;
    }
    .bar:nth-child(1){animation-delay:0s;}
    .bar:nth-child(2){animation-delay:0.2s;}
    .bar:nth-child(3){animation-delay:0.4s;}
    @keyframes soundbar{
      0%, 100%{height:6px}
      50%{height:14px}
    }

    @media (max-width:640px){
      .menuGrid{grid-template-columns:1fr;}
      video{max-height:200px;}
      .title{font-size:22px;}
    }

    /* =======================
       OCHO ORACLE STYLES
       ======================= */
    
    /* Pulsante OCHO con effetto stelline magiche */
    .ochoBtn{
      position:relative;
      overflow:visible !important;
    }
    
    .ochoBtn::before{
      content:'';
      position:absolute;
      inset:-2px;
      background:linear-gradient(45deg, var(--purple), var(--green), var(--purple));
      border-radius:14px;
      z-index:-1;
      opacity:0.6;
      animation:ochoGlow 3s ease-in-out infinite;
    }
    
    @keyframes ochoGlow{
      0%, 100%{opacity:0.4; filter:blur(8px);}
      50%{opacity:0.8; filter:blur(12px);}
    }
    
    /* Stelline magiche */
    .sparkle{
      position:absolute;
      width:4px;
      height:4px;
      background:var(--green);
      border-radius:50%;
      box-shadow:0 0 10px var(--green), 0 0 20px var(--green);
      animation:sparkleFloat 2s ease-in-out infinite;
      pointer-events:none;
    }
    
    @keyframes sparkleFloat{
      0%{opacity:0; transform:translateY(0) scale(0);}
      50%{opacity:1; transform:translateY(-20px) scale(1);}
      100%{opacity:0; transform:translateY(-40px) scale(0);}
    }
    
    /* PORTALE MATRIX - Effetto wormhole */
    .portal-overlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.95) 70%);
      z-index:1000;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.8s ease;
    }
    
    .portal-overlay.active{
      opacity:1;
      pointer-events:none; /* Cambiato da 'all' a 'none' - il portale √® solo sfondo! */
    }
    
    .wormhole{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%) scale(0);
      width:600px;
      height:600px;
      border-radius:50%;
      background:radial-gradient(circle, 
        rgba(0,255,154,0.2) 0%,
        rgba(0,255,154,0.1) 30%,
        transparent 70%);
      box-shadow:
        0 0 60px rgba(0,255,154,0.6),
        0 0 120px rgba(0,255,154,0.4),
        inset 0 0 60px rgba(0,255,154,0.3);
      animation:wormholeOpen 1s ease-out forwards;
      pointer-events:none; /* Il wormhole non blocca i click */
    }
    
    @keyframes wormholeOpen{
      0%{transform:translate(-50%, -50%) scale(0) rotate(0deg); opacity:0;}
      50%{transform:translate(-50%, -50%) scale(1.2) rotate(180deg); opacity:1;}
      100%{transform:translate(-50%, -50%) scale(1) rotate(360deg); opacity:1;}
    }
    
    .wormhole::before{
      content:'';
      position:absolute;
      inset:20px;
      border-radius:50%;
      border:2px solid rgba(0,255,154,0.4);
      animation:wormholeRing 2s linear infinite;
    }
    
    .wormhole::after{
      content:'';
      position:absolute;
      inset:40px;
      border-radius:50%;
      border:1px solid rgba(0,255,154,0.3);
      animation:wormholeRing 3s linear infinite reverse;
    }
    
    @keyframes wormholeRing{
      0%{transform:rotate(0deg) scale(1); opacity:0.8;}
      50%{transform:rotate(180deg) scale(0.95); opacity:0.4;}
      100%{transform:rotate(360deg) scale(1); opacity:0.8;}
    }
    
    /* Particelle del portale */
    .portal-particle{
      position:absolute;
      width:3px;
      height:3px;
      background:var(--green);
      border-radius:50%;
      box-shadow:0 0 10px var(--green);
      animation:portalParticle 3s ease-out infinite;
    }
    
    @keyframes portalParticle{
      0%{
        transform:translate(0, 0) scale(0);
        opacity:0;
      }
      30%{
        opacity:1;
      }
      100%{
        transform:translate(var(--tx), var(--ty)) scale(1);
        opacity:0;
      }
    }
    
    /* Chat Oracle dentro il portale */
    .oracleCard{
      position:relative;
      z-index:1003;
      width:100%;
      max-width:720px;
    }
    
    @keyframes cardAppear{
      0%{transform:scale(0.8); opacity:0;}
      100%{transform:scale(1); opacity:1;}
    }
    
    .oracleChat{
      max-height:340px;
      overflow-y:auto;
      background:rgba(0,0,0,.6);
      border:1px solid rgba(0,255,154,.3);
      border-radius:12px;
      padding:16px;
      margin:16px 0;
      font-size:14px;
      line-height:1.6;
      box-shadow:
        0 0 20px rgba(0,255,154,0.2),
        inset 0 0 20px rgba(0,255,154,0.1);
    }
    
    .oracleChat::-webkit-scrollbar{width:6px;}
    .oracleChat::-webkit-scrollbar-track{background:rgba(0,0,0,.3);}
    .oracleChat::-webkit-scrollbar-thumb{background:rgba(0,255,154,.4);border-radius:3px;}
    
    .message{
      margin-bottom:12px;
      padding:10px 14px;
      border-radius:10px;
      animation:messageSlide 0.3s ease;
    }
    
    @keyframes messageSlide{
      from{opacity:0; transform:translateY(10px);}
      to{opacity:1; transform:translateY(0);}
    }
    
    .message.user{
      background:rgba(31,111,255,.25);
      border:1px solid rgba(31,111,255,.4);
      text-align:right;
    }
    
    .message.oracle{
      background:rgba(0,255,154,.15);
      border:1px solid rgba(0,255,154,.3);
      color:var(--green);
      text-shadow:0 0 10px rgba(0,255,154,0.3);
    }
    
    /* Effetto typewriter magico */
    .magic-char{
      display:inline-block;
      animation:magicWave 2s ease-in-out infinite;
      text-shadow:
        0 0 10px rgba(0,255,154,0.6),
        0 0 20px rgba(0,255,154,0.4),
        0 0 30px rgba(0,255,154,0.2);
    }
    
    @keyframes magicWave{
      0%, 100%{
        transform:translateY(0px);
        opacity:1;
      }
      25%{
        transform:translateY(-8px);
        opacity:0.8;
      }
      50%{
        transform:translateY(0px);
        opacity:1;
      }
      75%{
        transform:translateY(8px);
        opacity:0.9;
      }
    }
    
    .typewriter-msg .magic-char{
      animation:magicAppear 0.5s ease-out, magicWave 2s ease-in-out infinite 0.5s;
    }
    
    @keyframes magicAppear{
      0%{
        opacity:0;
        transform:scale(0) translateY(-20px);
      }
      50%{
        opacity:1;
        transform:scale(1.2) translateY(0);
      }
      100%{
        opacity:1;
        transform:scale(1) translateY(0);
      }
    }
    
    .message.system{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.15);
      font-size:12px;
      opacity:0.8;
      text-align:center;
    }
    
    /* Pulsante microfono Oracle */
    .micBtn{
      width:64px;
      height:64px;
      border-radius:50%;
      background:rgba(0,0,0,.7);
      border:2px solid rgba(0,255,154,.4);
      color:var(--green);
      font-size:28px;
      cursor:pointer;
      transition:all 0.3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0 auto;
      box-shadow:0 0 20px rgba(0,255,154,.2);
    }
    
    .micBtn:hover{
      transform:scale(1.1);
      box-shadow:0 0 30px rgba(0,255,154,.4);
      border-color:var(--green);
    }
    
    .micBtn.listening{
      background:rgba(0,255,154,.2);
      animation:micPulse 1s ease-in-out infinite;
      border-color:var(--green);
    }
    
    @keyframes micPulse{
      0%, 100%{box-shadow:0 0 20px rgba(0,255,154,.4);}
      50%{box-shadow:0 0 40px rgba(0,255,154,.8);}
    }
    
    .oracleControls{
      display:flex;
      gap:8px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top:16px;
    }
    
    .miniBtn{
      padding:8px 16px;
      font-size:12px;
      border-radius:10px;
      background:rgba(0,0,0,.6);
      border:1px solid rgba(255,255,255,.15);
      color:#fff;
      cursor:pointer;
      transition:all 0.2s;
    }
    
    .miniBtn:hover{
      background:rgba(0,255,154,.15);
      border-color:var(--green);
      transform:translateY(-2px);
    }
  </style>
</head>

<body>
  <!-- Matrix Rain Canvas -->
  <canvas id="matrixCanvas"></canvas>
  
  <!-- Floating particles -->
  <div class="particles" id="particles"></div>

  <div class="bg" id="bg"></div>
  <div class="vignette"></div>
  <div class="scanlines"></div>

  <div class="wrap">
    <div class="panel">
      <div class="hud">
        <div class="brand"><b>O C H O</b></div>
        <div class="status">
          <span class="dot"></span>
          <span id="statusText">In attesa‚Ä¶</span>
          <div class="playing-indicator" id="playingIndicator">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
          </div>
        </div>
      </div>

      <!-- SCREEN: TOCCA PER ENTRARE -->
      <div class="screen active" id="screenEnter">
        <div class="card">
          <h1 class="title">TOCCA PER ENTRARE</h1>
          <p class="subtitle">Inizia l'esperienza OCHO</p>
          <div class="controls">
            <button class="btn green" id="enterBtn">ACCEDI AL SISTEMA</button>
          </div>
        </div>
      </div>

      <!-- SCREEN: PILLs -->
      <div class="screen hidden" id="screenPills">
        <div class="card">
          <h1 class="title">SCEGLI LA PILLOLA</h1>
          <p class="subtitle">Pillola blu: ritorni alla realt√†<br>Pillola rossa: scopri quanto √® profonda la tana</p>
          <div class="controls">
            <button class="btn blue" id="blueBtn"><span class="pill blue"></span>Pillola Blu</button>
            <button class="btn red" id="redBtn"><span class="pill red"></span>Pillola Rossa</button>
          </div>
        </div>
      </div>

      <!-- SCREEN: RED MENU -->
      <div class="screen hidden" id="screenMenu">
        <div class="card">
          <h1 class="title">ARCHIVIO DIGITALE</h1>
          <p class="subtitle">Seleziona una categoria</p>

          <div class="menuGrid">
            <button class="menuBtn" data-cat="frasi">
              <span>FRASI</span>
              <span class="btnCaption">assiomi da cui partire, non conclusioni da dimostrare</span>
              <span class="newBadge" data-badge="frasi" style="display:none">NEW</span>
            </button>
            <button class="menuBtn" data-cat="song">
              <span>SONG</span>
              <span class="btnCaption">frequenze sonore del campo</span>
              <span class="newBadge" data-badge="song" style="display:none">NEW</span>
            </button>
            <button class="menuBtn" data-cat="broadcast">
              <span>BROADCAST</span>
              <span class="btnCaption">trasmissioni dal sistema</span>
              <span class="newBadge" data-badge="broadcast" style="display:none">NEW</span>
            </button>
            <button class="menuBtn" data-cat="video">
              <span>VIDEO</span>
              <span class="btnCaption">proiezioni visive della matrice</span>
              <span class="newBadge" data-badge="video" style="display:none">NEW</span>
            </button>
            <button class="menuBtn ochoBtn" id="ochoBtn">
              <span>üîÆ OCHO</span>
              <span class="btnCaption">consulta l'oracolo del sistema</span>
            </button>
          </div>

          <div class="row">
            <button class="ghost" id="backToPills">‚üµ Torna alle pillole</button>
          </div>
        </div>
      </div>

      <!-- SCREEN: ORACLE OCHO -->
      <div class="screen hidden" id="screenOracle">
        <div class="card oracleCard">
          <h1 class="title">üîÆ OCHO - ORACOLO DEL SISTEMA</h1>
          <p class="subtitle">Fai la tua domanda usando il microfono. OCHO risponder√† con saggezza antica.</p>

          <!-- Chat messages -->
          <div class="oracleChat" id="oracleChat">
            <!-- I messaggi appariranno qui dinamicamente -->
          </div>

          <!-- Microfono -->
          <button class="micBtn" id="micBtn" title="Clicca per parlare">
            üé§
          </button>

          <!-- Controlli -->
          <div class="oracleControls">
            <button class="miniBtn" id="clearChatBtn">üóëÔ∏è Pulisci Chat</button>
            <button class="miniBtn" id="backFromOracle">‚Üê Menu</button>
          </div>
        </div>
      </div>

      <!-- PLAYER -->
      <div class="playerbar" id="playerbar">
        <div class="track" id="track">‚Äî</div>
        <div class="progress-info">
          <span id="timeText">0:00 / 0:00</span>
        </div>
        <audio id="audio" controls></audio>
        <video id="video" controls class="hidden"></video>
        
        <div class="player-controls">
          <button id="prevBtn">‚óÑ PREC</button>
          <button id="nextBtn">SUCC ‚ñ∫</button>
          <button id="shuffleBtn">‚ßâ CASUALE</button>
        </div>
        
        <button class="stopBtn" id="stopBtn">‚ñ† STOP - TORNA AL MENU</button>
      </div>

      <!-- AUDIO INTRO -->
      <audio id="introAudio" preload="auto" src="mp3/inizio.mp3"></audio>
    </div>
  </div>

  <!-- PORTALE MATRIX per OCHO -->
  <div class="portal-overlay" id="portalOverlay">
    <div class="wormhole" id="wormhole"></div>
  </div>

<script>
/* =======================
   CONFIG GITHUB
   ======================= */
const GITHUB_USER = "fabriziodadamo72-source";
const GITHUB_REPO = "jukebox-random";
const GITHUB_BRANCH = "main";
const ANSA_URL = "https://www.ansa.it/";

const FOLDERS = {
  frasi: { path: "mp3", exts: [".mp3"], exclude: ["inizio.mp3"] },
  song: { path: "song", exts: [".mp3"] },
  broadcast: { path: "broadcast", exts: [".mp3"] },
  video: { path: "mp4", exts: [".mp4", ".avi", ".mov", ".webm"] }
};

/* =======================
   ORACLE API KEY
   ======================= */
const ANTHROPIC_API_KEY = "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";

/* =======================
   STATE
   ======================= */
const playlists = new Map();
const decks = new Map();
const deckPos = new Map();
let currentCat = "frasi";
let shuffleMode = true;
let playHistory = [];

// AUTOMATIC NEW DETECTION
let fileSnapshots = {}; // Snapshot dei file alla prima visita
let seenFiles = {}; // File che l'utente ha effettivamente ascoltato

// Load from localStorage
try {
  if (localStorage.getItem('ocho_snapshots')) {
    fileSnapshots = JSON.parse(localStorage.getItem('ocho_snapshots'));
  }
  if (localStorage.getItem('ocho_seen')) {
    seenFiles = JSON.parse(localStorage.getItem('ocho_seen'));
  }
} catch(e) {
  console.log("localStorage error:", e);
}

/* =======================
   ORACLE STATE
   ======================= */
let recognition = null;
let isListening = false;
let libraryLoaded = false;
let libraryTexts = [];

/* =======================
   ELEMENTS
   ======================= */
const bg = document.getElementById("bg");
const statusText = document.getElementById("statusText");
const playingIndicator = document.getElementById("playingIndicator");

const screenEnter = document.getElementById("screenEnter");
const screenPills = document.getElementById("screenPills");
const screenMenu = document.getElementById("screenMenu");
const screenOracle = document.getElementById("screenOracle");

const introAudio = document.getElementById("introAudio");

const playerbar = document.getElementById("playerbar");
const trackEl = document.getElementById("track");
const filenameEl = document.getElementById("filename");
const progressText = document.getElementById("progressText");
const timeText = document.getElementById("timeText");
const audio = document.getElementById("audio");
const video = document.getElementById("video");
const shuffleBtn = document.getElementById("shuffleBtn");

/* =======================
   MATRIX RAIN EFFECT
   ======================= */
const canvas = document.getElementById("matrixCanvas");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()";
const fontSize = 14;
const columns = canvas.width / fontSize;
const drops = Array(Math.floor(columns)).fill(1);

function drawMatrix() {
  ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  ctx.fillStyle = "#00ff9a";
  ctx.font = fontSize + "px monospace";
  
  for (let i = 0; i < drops.length; i++) {
    const text = chars[Math.floor(Math.random() * chars.length)];
    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
    
    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
      drops[i] = 0;
    }
    drops[i]++;
  }
}

setInterval(drawMatrix, 50);

window.addEventListener("resize", () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

/* =======================
   FLOATING PARTICLES
   ======================= */
function createParticles() {
  const container = document.getElementById("particles");
  for (let i = 0; i < 20; i++) {
    const particle = document.createElement("div");
    particle.className = "particle";
    particle.style.left = Math.random() * 100 + "%";
    particle.style.animationDelay = Math.random() * 15 + "s";
    particle.style.animationDuration = (10 + Math.random() * 10) + "s";
    container.appendChild(particle);
  }
}
createParticles();

/* =======================
   HELPERS
   ======================= */
function setStatus(msg) { 
  statusText.textContent = msg; 
}

function show(which) {
  console.log("üîç show() chiamata con:", which);
  const screens = [screenEnter, screenPills, screenMenu, screenOracle];
  screens.forEach(s => {
    if (s.id === `screen${which.charAt(0).toUpperCase() + which.slice(1)}`) {
      console.log("‚úÖ Mostrando:", s.id);
      s.classList.remove("hidden");
      setTimeout(() => s.classList.add("active"), 10);
    } else {
      console.log("‚ùå Nascondendo:", s.id);
      s.classList.remove("active");
      setTimeout(() => s.classList.add("hidden"), 400);
    }
  });
}

function showPlayer(on) { 
  playerbar.classList.toggle("on", !!on); 
  playingIndicator.classList.toggle("active", !!on);
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

/* =======================
   AUTOMATIC NEW DETECTION (SHA-based + Timestamp)
   ======================= */
const NEW_FILE_DAYS = 30; // File √® NEW per max 30 giorni da quando l'hai scoperto

function saveSnapshotWithHashes(cat, filesWithHashes) {
  // Salva SHA dei file + timestamp di quando li hai visti la prima volta
  if (!fileSnapshots[cat]) {
    fileSnapshots[cat] = {};
  }
  
  const now = new Date().toISOString();
  
  filesWithHashes.forEach(fileObj => {
    // Se √® un file gi√† conosciuto, mantieni il timestamp originale
    if (!fileSnapshots[cat][fileObj.name]) {
      fileSnapshots[cat][fileObj.name] = {
        sha: fileObj.sha,
        firstSeen: now  // Quando l'hai visto la prima volta
      };
    } else {
      // File esistente: aggiorna SHA se cambiato
      fileSnapshots[cat][fileObj.name].sha = fileObj.sha;
    }
  });
  
  localStorage.setItem('ocho_snapshots', JSON.stringify(fileSnapshots));
  console.log(`üì∏ Snapshot salvato per ${cat}:`, filesWithHashes.length, 'file');
}

function isFileRecentlyDiscovered(firstSeenDate) {
  // Controlla se il file √® stato scoperto negli ultimi X giorni
  if (!firstSeenDate) return true; // Se non ha data, consideralo nuovo
  
  const discoveredDate = new Date(firstSeenDate);
  const now = new Date();
  const daysDiff = (now - discoveredDate) / (1000 * 60 * 60 * 24);
  
  return daysDiff <= NEW_FILE_DAYS;
}

function isNewAndUnseen(cat, filename) {
  // Un file √® "NEW e non visto" se:
  // 1. √à stato scoperto negli ultimi 30 giorni
  // 2. L'utente NON l'ha ancora ascoltato
  
  if (!fileSnapshots[cat] || !fileSnapshots[cat][filename]) {
    // File mai visto prima = NEW
    return true;
  }
  
  const fileInfo = fileSnapshots[cat][filename];
  const isRecentlyDiscovered = isFileRecentlyDiscovered(fileInfo.firstSeen);
  const hasBeenSeen = seenFiles[cat] && seenFiles[cat].includes(filename);
  
  return isRecentlyDiscovered && !hasBeenSeen;
}

function markAsSeen(cat, filename) {
  if (!seenFiles[cat]) seenFiles[cat] = [];
  if (!seenFiles[cat].includes(filename)) {
    seenFiles[cat].push(filename);
    localStorage.setItem('ocho_seen', JSON.stringify(seenFiles));
    console.log(`‚úÖ ${filename} marcato come visto`);
    
    // Aggiorna i badge dopo aver visto un file
    updateNewBadges();
  }
}

function updateNewBadges() {
  // Aggiorna i badge con il conteggio dei file nuovi non ascoltati
  for (const cat in fileSnapshots) {
    const badge = document.querySelector(`[data-badge="${cat}"]`);
    if (!badge) continue;
    
    const filesInCat = fileSnapshots[cat];
    
    // Conta file recentemente scoperti NON ancora visti
    let newUnseenCount = 0;
    for (const filename in filesInCat) {
      const fileInfo = filesInCat[filename];
      const isRecent = isFileRecentlyDiscovered(fileInfo.firstSeen);
      const hasBeenSeen = seenFiles[cat] && seenFiles[cat].includes(filename);
      
      if (isRecent && !hasBeenSeen) {
        newUnseenCount++;
      }
    }
    
    if (newUnseenCount > 0) {
      badge.style.display = "block";
      badge.textContent = `${newUnseenCount} NEW`;
      console.log(`üÜï ${cat}: ${newUnseenCount} file nuovi non visti`);
    } else {
      badge.style.display = "none";
    }
  }
}

async function preloadAllCategories() {
  // Pre-carica tutte le categorie in background per calcolare i badge
  console.log("üîÑ Pre-caricamento categorie per badge NEW...");
  
  for (const cat in FOLDERS) {
    try {
      await loadCat(cat);
    } catch(e) {
      console.log(`Errore pre-caricamento ${cat}:`, e);
    }
  }
  
  console.log("‚úÖ Pre-caricamento completato!");
  updateNewBadges();
}

async function loadCategoriesInBackground() {
  // Carica progressivamente solo le categorie NON ancora caricate
  console.log("üîÑ Caricamento progressivo in background...");
  
  for (const cat in FOLDERS) {
    // Salta se gi√† caricata
    if (playlists.has(cat)) {
      console.log(`‚è≠Ô∏è ${cat} gi√† caricata`);
      continue;
    }
    
    try {
      console.log(`‚è≥ Caricamento ${cat}...`);
      await loadCat(cat);
      
      // Pausa tra categorie per evitare rate limiting
      await new Promise(resolve => setTimeout(resolve, 1000));
    } catch(e) {
      console.log(`‚ùå Errore ${cat}:`, e);
    }
  }
  
  console.log("‚úÖ Caricamento background completato!");
}

/* =======================
   GITHUB API
   ======================= */
async function fetchGitHubFolder(folderPath) {
  const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${folderPath}?ref=${GITHUB_BRANCH}`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);
    const data = await res.json();
    
    // Ottieni file con SHA (hash) invece di date commit
    // SHA cambia quando il file cambia - pi√π veloce!
    const filesWithHashes = data
      .filter(item => item.type === "file")
      .map(item => ({
        name: item.name,
        sha: item.sha,  // Hash unico del file
        size: item.size
      }));
    
    return filesWithHashes;
  } catch (e) {
    console.error("Errore fetch GitHub:", e);
    return [];
  }
}

async function loadCat(cat) {
  if (playlists.has(cat)) {
    // Se gi√† caricata, aggiorna solo i badge
    updateNewBadges();
    return true;
  }
  
  setStatus(`Caricamento ${cat}...`);
  const config = FOLDERS[cat];
  if (!config) {
    console.error("Categoria sconosciuta:", cat);
    return false;
  }

  const allFilesWithHashes = await fetchGitHubFolder(config.path);
  
  // Filtra per estensione ed esclusioni
  let filesWithHashes = allFilesWithHashes.filter(fileObj => {
    const lower = fileObj.name.toLowerCase();
    const hasExt = config.exts.some(ext => lower.endsWith(ext));
    const isExcluded = (config.exclude || []).some(ex => fileObj.name === ex);
    return hasExt && !isExcluded;
  });

  if (!filesWithHashes.length) {
    setStatus(`Nessun file in ${cat}`);
    trackEl.textContent = `ERRORE: Nessun file trovato in ${config.path}/`;
    showPlayer(true);
    return false;
  }

  // Crea array di percorsi completi
  const files = filesWithHashes.map(f => `${config.path}/${f.name}`);
  playlists.set(cat, files);
  
  // SNAPSHOT CON HASH: salva nome file + SHA + timestamp
  saveSnapshotWithHashes(cat, filesWithHashes);
  
  resetDeck(cat);
  
  // Aggiorna i badge dopo il caricamento
  updateNewBadges();
  
  console.log(`‚úÖ ${cat}: ${files.length} file caricati`);
  return true;
}

function resetDeck(cat) {
  const files = playlists.get(cat) || [];
  const n = files.length;
  const indices = [...Array(n).keys()];
  
  // Separa indici di file NEW non visti da altri
  const newIndices = [];
  const otherIndices = [];
  
  indices.forEach(idx => {
    const filename = files[idx].split('/').pop();
    if (isNewAndUnseen(cat, filename)) {
      newIndices.push(idx);
    } else {
      otherIndices.push(idx);
    }
  });
  
  // Shuffle separatamente
  const shuffledNew = shuffleMode ? shuffle([...newIndices]) : newIndices;
  const shuffledOthers = shuffleMode ? shuffle([...otherIndices]) : otherIndices;
  
  // Metti i NEW all'inizio
  const finalDeck = [...shuffledNew, ...shuffledOthers];
  
  decks.set(cat, finalDeck);
  deckPos.set(cat, 0);
}

function draw(cat) {
  const list = playlists.get(cat) || [];
  if (!list.length) return -1;
  if (!decks.has(cat) || !deckPos.has(cat)) resetDeck(cat);

  let p = deckPos.get(cat);
  const d = decks.get(cat);
  if (p >= d.length) { resetDeck(cat); p = 0; }
  const idx = d[p];
  deckPos.set(cat, p + 1);
  return idx;
}

function drawPrev(cat) {
  const list = playlists.get(cat) || [];
  if (!list.length) return -1;
  
  let p = deckPos.get(cat);
  p = p - 2; // Go back 2 (one for current, one for previous)
  if (p < 0) p = decks.get(cat).length - 1;
  deckPos.set(cat, p);
  
  return draw(cat);
}

function updateProgress() {
  const pos = deckPos.get(currentCat) || 0;
  const total = (playlists.get(currentCat) || []).length;
  progressText.textContent = `File ${pos}/${total}`;
}

function updateTime() {
  const media = currentCat === "video" ? video : audio;
  if (media.duration) {
    timeText.textContent = `${formatTime(media.currentTime)} / ${formatTime(media.duration)}`;
  }
}

function playPath(cat, src) {
  currentCat = cat;
  showPlayer(true);
  trackEl.textContent = `[${cat.toUpperCase()}]`;
  
  const filename = src.split('/').pop();
  
  // Marca il file come visto
  markAsSeen(cat, filename);
  
  setStatus("In riproduzione‚Ä¶");

  if (cat === "video") {
    audio.pause();
    audio.classList.add("hidden");
    video.classList.remove("hidden");
    video.src = src;
    video.play().then(() => {
      if (video.requestFullscreen) {
        video.requestFullscreen().catch(() => {});
      } else if (video.webkitRequestFullscreen) {
        video.webkitRequestFullscreen();
      } else if (video.mozRequestFullScreen) {
        video.mozRequestFullScreen();
      }
    }).catch(() => {});
  } else {
    video.pause();
    video.classList.add("hidden");
    audio.classList.remove("hidden");
    audio.src = src;
    audio.play().catch(() => {});
  }
  
  playHistory.push({cat, src, time: new Date()});
  if (playHistory.length > 50) playHistory.shift();
}

async function playNext(cat) {
  const ok = await loadCat(cat);
  if (!ok) return;
  const idx = draw(cat);
  const src = playlists.get(cat)[idx];
  playPath(cat, src);
}

async function playPrev(cat) {
  const ok = await loadCat(cat);
  if (!ok) return;
  const idx = drawPrev(cat);
  const src = playlists.get(cat)[idx];
  playPath(cat, src);
}

/* =======================
   EVENTS
   ======================= */

document.getElementById("enterBtn").addEventListener("click", () => {
  setStatus("Avvio‚Ä¶");
  introAudio.currentTime = 0;
  introAudio.play().catch(() => {});
  bg.style.backgroundImage =
    `radial-gradient(1200px 700px at 50% 70%, rgba(0,255,154,.12), transparent 60%),
     radial-gradient(900px 500px at 50% 40%, rgba(0,255,154,.10), transparent 60%),
     url("assets/inizio.jpeg") center/cover no-repeat`;
  show("pills");
  setStatus("Pronto.");
});

document.getElementById("blueBtn").addEventListener("click", () => {
  introAudio.pause();
  window.open(ANSA_URL, "_blank", "noopener,noreferrer");
});

document.getElementById("redBtn").addEventListener("click", () => {
  introAudio.pause();
  show("menu");
  setStatus("Menu.");
  
  // Mostra badge per categorie gi√† caricate
  updateNewBadges();
  
  // Carica progressivamente le categorie NON ancora caricate in background
  setTimeout(() => {
    loadCategoriesInBackground();
  }, 500);
});

document.getElementById("backToPills").addEventListener("click", () => {
  show("pills");
  setStatus("Pronto.");
});

document.querySelectorAll(".menuBtn[data-cat]").forEach(b => {
  b.addEventListener("click", () => playNext(b.dataset.cat));
});

document.getElementById("prevBtn").addEventListener("click", () => {
  playPrev(currentCat);
});

document.getElementById("nextBtn").addEventListener("click", () => {
  playNext(currentCat);
});

shuffleBtn.addEventListener("click", () => {
  shuffleMode = !shuffleMode;
  shuffleBtn.classList.toggle("active", shuffleMode);
  resetDeck(currentCat);
  setStatus(shuffleMode ? "Casuale ON" : "Casuale OFF");
});
shuffleBtn.classList.add("active");

document.getElementById("stopBtn").addEventListener("click", () => {
  audio.pause();
  audio.src = "";
  video.pause();
  video.src = "";
  
  if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    }
  }
  
  showPlayer(false);
  show("menu");
  setStatus("Menu.");
});

audio.addEventListener("ended", () => playNext(currentCat));
video.addEventListener("ended", () => playNext(currentCat));

audio.addEventListener("timeupdate", updateTime);
video.addEventListener("timeupdate", updateTime);

/* =======================
   ORACLE SYSTEM
   ======================= */

// Elementi DOM Oracle
const oracleChat = document.getElementById("oracleChat");
const micBtn = document.getElementById("micBtn");
const clearChatBtn = document.getElementById("clearChatBtn");
const backFromOracle = document.getElementById("backFromOracle");
const ochoBtn = document.getElementById("ochoBtn");
const portalOverlay = document.getElementById("portalOverlay");
const wormhole = document.getElementById("wormhole");

// Apri portale Matrix
function openPortal() {
  // Attiva il portale
  portalOverlay.classList.add('active');
  
  // Crea particelle del portale
  for (let i = 0; i < 50; i++) {
    const particle = document.createElement('div');
    particle.className = 'portal-particle';
    
    // Posizione casuale dal centro
    const angle = (Math.random() * 360) * Math.PI / 180;
    const distance = Math.random() * 300;
    const tx = Math.cos(angle) * distance;
    const ty = Math.sin(angle) * distance;
    
    particle.style.setProperty('--tx', `${tx}px`);
    particle.style.setProperty('--ty', `${ty}px`);
    particle.style.left = '50%';
    particle.style.top = '50%';
    particle.style.animationDelay = `${Math.random() * 0.5}s`;
    
    wormhole.appendChild(particle);
  }
  
  // Mostra la schermata Oracle dopo l'animazione
  setTimeout(() => {
    show("screenOracle");
    setStatus("OCHO attivo");
    
    // Svuota chat e mostra messaggio di benvenuto magico
    oracleChat.innerHTML = '';
    
    setTimeout(() => {
      showMagicTypewriter("Io sono OCHO. Il portale √® aperto. Fai la tua domanda e ti riveler√≤ ci√≤ che so.");
    }, 300);
    
    if (!libraryLoaded) {
      loadLibrary();
    }
  }, 800);
}

// Chiudi portale
function closePortal() {
  portalOverlay.classList.remove('active');
  
  // Pulisci particelle
  setTimeout(() => {
    wormhole.innerHTML = '';
  }, 800);
}

// Crea stelline magiche sul pulsante OCHO
function createSparkles() {
  const button = ochoBtn;
  if (!button) return;
  
  setInterval(() => {
    const sparkle = document.createElement('div');
    sparkle.className = 'sparkle';
    
    // Posizione casuale attorno al pulsante
    const angle = Math.random() * 360;
    const distance = 30 + Math.random() * 20;
    const x = Math.cos(angle * Math.PI / 180) * distance;
    const y = Math.sin(angle * Math.PI / 180) * distance;
    
    sparkle.style.left = `calc(50% + ${x}px)`;
    sparkle.style.top = `calc(50% + ${y}px)`;
    sparkle.style.animationDelay = Math.random() * 2 + 's';
    
    button.appendChild(sparkle);
    
    // Rimuovi dopo l'animazione
    setTimeout(() => sparkle.remove(), 2000);
  }, 300);
}

// Inizializza il riconoscimento vocale (lazy loading)
function initSpeechRecognition() {
  if (recognition) return; // Gi√† inizializzato
  
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'it-IT';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    addSystemMessage('üé§ Microfono inizializzato');
  } else {
    addSystemMessage('‚ùå Riconoscimento vocale non supportato in questo browser');
  }
}

// Carica la biblioteca dalla cartella libreria/
async function loadLibrary() {
  if (libraryLoaded) return;
  
  addSystemMessage('üìö Caricamento conoscenza OCHO...');
  
  try {
    const url = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/libreria?ref=${GITHUB_BRANCH}`;
    const res = await fetch(url);
    
    if (!res.ok) {
      addSystemMessage('‚ö†Ô∏è Cartella libreria/ non trovata - modalit√† base attiva');
      libraryLoaded = true;
      return;
    }
    
    const files = await res.json();
    const txtFiles = files.filter(f => f.name.endsWith('.txt'));
    
    for (const file of txtFiles) {
      const contentRes = await fetch(file.download_url);
      const content = await contentRes.text();
      libraryTexts.push({
        filename: file.name,
        content: content
      });
    }
    
    addSystemMessage(`‚úÖ ${txtFiles.length} documenti caricati. OCHO pronto.`);
    libraryLoaded = true;
    
  } catch (error) {
    console.error('Errore caricamento libreria:', error);
    addSystemMessage('‚ö†Ô∏è Errore caricamento - modalit√† base attiva');
    libraryLoaded = true;
  }
}

// Aggiungi messaggio alla chat
function addMessage(text, type = 'oracle') {
  const msg = document.createElement('div');
  msg.className = `message ${type}`;
  msg.textContent = text;
  oracleChat.appendChild(msg);
  oracleChat.scrollTop = oracleChat.scrollHeight;
}

function addSystemMessage(text) {
  addMessage(text, 'system');
}

// Chiedi a Claude (Anthropic API)
async function askOracle(question) {
  if (!question || question.trim() === '') return;
  
  addMessage(question, 'user');
  addSystemMessage('üîÆ OCHO sta elaborando...');
  
  if (!ANTHROPIC_API_KEY || ANTHROPIC_API_KEY === "LA_TUA_CHIAVE_ANTHROPIC") {
    addMessage("‚ö†Ô∏è API Key Anthropic non configurata! Inserisci la tua chiave nel codice.", 'oracle');
    return;
  }
  
  if (!libraryLoaded) {
    await loadLibrary();
  }
  
  // Prepara il contesto dalla libreria
  const libraryContext = libraryTexts.length > 0 
    ? libraryTexts.map(t => `[Fonte: ${t.filename}]\n${t.content}`).join('\n\n---\n\n')
    : "Nessun documento di conoscenza disponibile.";
  
  const systemPrompt = `Sei OCHO, un'entit√† saggia che POSSIEDE questa conoscenza nel suo essere.

La tua conoscenza proviene da:
${libraryContext}

REGOLE FONDAMENTALI:
1. Parla in PRIMA PERSONA - questa conoscenza √® TUA, non di altri
2. MAI citare fonti, nomi, autori o riferimenti esterni
3. MAI dire "secondo", "nell'intervista", "da", o simili
4. Risposte BREVI - massimo 3-4 frasi concise e dirette
5. MAI ripetere concetti gi√† espressi
6. Se non sai, d√¨ semplicemente "Questo non √® nella mia conoscenza"
7. Tono diretto, mistico ma essenziale
8. Rispondi sempre in italiano

Esempi:
‚ùå MALE: "Secondo il testo, le anime sono..."
‚úÖ BENE: "Le anime sono scintille di coscienza universale."

Assorbi i concetti, parlali come tuoi, sii breve e diretto.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 300,
        messages: [{
          role: 'user',
          content: question
        }],
        system: systemPrompt
      })
    });
    
    if (!response.ok) {
      throw new Error(`API Error: ${response.status}`);
    }
    
    const data = await response.json();
    const answer = data.content[0].text;
    
    // Rimuovi il messaggio di caricamento
    const loadingMsg = oracleChat.querySelector('.message.system:last-child');
    if (loadingMsg && loadingMsg.textContent.includes('elaborando')) {
      loadingMsg.remove();
    }
    
    // Mostra risposta con effetto typewriter magico
    showMagicTypewriter(answer);
    
  } catch (error) {
    console.error('Errore Anthropic API:', error);
    addMessage(`Errore: ${error.message}`, 'system');
  }
}

// Mostra risposta con effetto typewriter magico ondeggiante
async function showMagicTypewriter(text) {
  if (!text) return;
  
  // Crea il messaggio container
  const msg = document.createElement('div');
  msg.className = 'message oracle typewriter-msg';
  msg.style.minHeight = '40px';
  oracleChat.appendChild(msg);
  oracleChat.scrollTop = oracleChat.scrollHeight;
  
  // Mostra testo lettera per lettera con effetto onda
  let index = 0;
  const speed = 30; // millisecondi per lettera
  
  return new Promise((resolve) => {
    const interval = setInterval(() => {
      if (index < text.length) {
        // Crea span per ogni lettera con effetto onda
        const char = text[index];
        const span = document.createElement('span');
        span.textContent = char;
        span.className = 'magic-char';
        span.style.animationDelay = `${index * 0.05}s`;
        msg.appendChild(span);
        
        index++;
        oracleChat.scrollTop = oracleChat.scrollHeight;
      } else {
        clearInterval(interval);
        resolve();
      }
    }, speed);
  });
}

// Avvia l'ascolto
function startListening() {
  initSpeechRecognition(); // Inizializza solo ora
  
  if (!recognition) {
    addSystemMessage('‚ùå Riconoscimento vocale non supportato');
    return;
  }
  
  isListening = true;
  micBtn.classList.add('listening');
  addSystemMessage('üé§ In ascolto... parla ora');
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    stopListening();
    askOracle(transcript);
  };
  
  recognition.onerror = (event) => {
    console.error('Speech recognition error:', event.error);
    stopListening();
    addSystemMessage(`‚ùå Errore: ${event.error}`);
  };
  
  recognition.onend = () => {
    if (isListening) {
      stopListening();
    }
  };
  
  recognition.start();
}

// Ferma l'ascolto
function stopListening() {
  isListening = false;
  micBtn.classList.remove('listening');
  if (recognition) {
    recognition.stop();
  }
}

// Event Listeners Oracle
ochoBtn.addEventListener("click", () => {
  openPortal();
});

backFromOracle.addEventListener("click", () => {
  closePortal();
  setTimeout(() => {
    show("menu");
    setStatus("Menu");
  }, 500);
  
  if (isListening) {
    stopListening();
  }
});

micBtn.addEventListener("click", () => {
  if (isListening) {
    stopListening();
  } else {
    startListening();
  }
});

clearChatBtn.addEventListener("click", () => {
  oracleChat.innerHTML = '<div class="message system">üåå Chat pulita. OCHO pronto.</div>';
});

// Inizializza stelline magiche
createSparkles();

/* BOOT */
show("enter");
setStatus("In attesa‚Ä¶");

console.log("üöÄ OCHO con Auto-Detection NEW OTTIMIZZATO!");
console.log(`üìÖ File NEW = scoperti negli ultimi ${NEW_FILE_DAYS} giorni`);
console.log("‚ö° Caricamento ON-DEMAND (no rate limiting!)");
console.log("üìä Categorie tracciate:", Object.keys(fileSnapshots).length);
</script>
</body>
</html>
