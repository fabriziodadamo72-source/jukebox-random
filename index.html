<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OCHO ‚Ä¢ Jukebox</title>

  <style>
    :root{ 
      --green:#00ff9a; 
      --blue:#1f6fff; 
      --red:#ff2d2d;
      --dark:#0a0e0d;
      --purple:#9d4edd;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--dark);color:#eafff6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    body{overflow:hidden}

    /* Matrix Rain Background */
    #matrixCanvas{
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      opacity:0.15;
      pointer-events:none;
      z-index:1;
    }

    /* Background container */
    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 700px at 50% 70%, rgba(0,255,154,.12), transparent 60%),
        radial-gradient(900px 500px at 50% 40%, rgba(0,255,154,.10), transparent 60%),
        linear-gradient(135deg, rgba(0,0,0,0.95), rgba(10,14,13,0.98));
      filter:saturate(1.1) contrast(1.08);
      transform:scale(1.02);
      z-index:2;
    }
    .vignette{
      position:fixed; 
      inset:-40px; 
      background:radial-gradient(circle at 50% 55%, transparent 35%, rgba(0,0,0,.8) 78%); 
      pointer-events:none;
      z-index:3;
    }
    .scanlines{
      position:fixed; 
      inset:0; 
      background:repeating-linear-gradient(to bottom, rgba(255,255,255,.02), rgba(255,255,255,.02) 1px, rgba(0,0,0,0) 3px, rgba(0,0,0,0) 6px); 
      mix-blend-mode:overlay; 
      opacity:.45; 
      pointer-events:none;
      z-index:4;
      animation:scan 8s linear infinite;
    }
    @keyframes scan{
      0%{transform:translateY(0)}
      100%{transform:translateY(10px)}
    }

    /* Floating particles */
    .particles{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:3;
    }
    .particle{
      position:absolute;
      width:3px;
      height:3px;
      background:var(--green);
      border-radius:50%;
      opacity:0;
      animation:float 15s infinite;
      box-shadow:0 0 10px var(--green);
    }
    @keyframes float{
      0%{opacity:0;transform:translateY(100vh) translateX(0)}
      10%{opacity:0.6}
      90%{opacity:0.3}
      100%{opacity:0;transform:translateY(-20vh) translateX(100px)}
    }

    .wrap{
      position:relative;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:10;
    }
    .panel{
      width:min(980px,96vw); 
      height:min(640px,92vh);
      border:1px solid rgba(0,255,154,.35);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.45));
      box-shadow:
        0 0 0 1px rgba(0,255,154,.15) inset, 
        0 0 40px rgba(0,255,154,.2),
        0 25px 80px rgba(0,0,0,.7);
      position:relative; 
      overflow:hidden;
      animation:panelGlow 3s ease-in-out infinite;
    }
    @keyframes panelGlow{
      0%, 100%{box-shadow:0 0 0 1px rgba(0,255,154,.15) inset, 0 0 40px rgba(0,255,154,.2), 0 25px 80px rgba(0,0,0,.7);}
      50%{box-shadow:0 0 0 1px rgba(0,255,154,.25) inset, 0 0 60px rgba(0,255,154,.3), 0 25px 80px rgba(0,0,0,.7);}
    }

    .hud{
      position:absolute; 
      left:16px; 
      right:16px; 
      top:14px;
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:12px;
      pointer-events:none;
      z-index:20;
    }
    .brand{display:flex;flex-direction:column;gap:2px;}
    .brand b{
      letter-spacing:.30em;
      color:var(--green);
      text-shadow:0 0 15px rgba(0,255,154,.5), 0 0 30px rgba(0,255,154,.3);
      font-size:14px;
      animation:glitch 5s infinite;
    }
    @keyframes glitch{
      0%, 90%, 100%{transform:translate(0)}
      91%{transform:translate(-2px, 1px)}
      92%{transform:translate(2px, -1px)}
      93%{transform:translate(0)}
    }

    .status{
      font-size:12px;
      color:#bfffe7;
      opacity:.9;
      text-align:right;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .status .dot{
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:50%;
      background:var(--green);
      box-shadow:0 0 12px rgba(0,255,154,.8);
      animation:pulse 2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%, 100%{opacity:1;transform:scale(1)}
      50%{opacity:0.6;transform:scale(0.9)}
    }

    .screen{
      position:absolute; 
      inset:0; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      padding:26px;
      opacity:0;
      transition:opacity 0.4s ease;
    }
    .screen.active{opacity:1;}
    .hidden{display:none;}

    .card{
      width:min(720px,92%);
      background:rgba(0,0,0,.55);
      border:1px solid rgba(0,255,154,.25);
      border-radius:18px;
      padding:26px 24px;
      box-shadow:
        0 0 0 1px rgba(0,255,154,.12) inset,
        0 10px 40px rgba(0,0,0,.5);
      backdrop-filter:blur(10px);
      text-align:center;
      transform:scale(0.95);
      transition:transform 0.4s ease;
    }
    .screen.active .card{transform:scale(1);}

    .title{
      margin:0 0 10px;
      font-size:26px;
      letter-spacing:.08em;
      text-shadow:0 0 20px rgba(0,255,154,.3);
      background:linear-gradient(135deg, #fff, var(--green));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .subtitle{margin:0 0 14px;font-size:13px;line-height:1.45;opacity:.9;}
    .controls{margin-top:18px;display:flex;gap:14px;justify-content:center;flex-wrap:wrap;}

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      border-radius:16px;
      background:rgba(0,0,0,.6);
      color:#fff;
      padding:14px 20px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      transition:all .2s ease;
      -webkit-tap-highlight-color:transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      position:relative;
      overflow:hidden;
    }
    .btn:before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg, transparent, rgba(255,255,255,.1), transparent);
      transform:translateX(-100%);
      transition:transform 0.6s;
    }
    .btn:hover:before{transform:translateX(100%);}
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 5px 20px rgba(0,255,154,.3);
    }
    .btn:active{transform:translateY(0) scale(.98);}
    .btn.blue{border-color:rgba(31,111,255,.4); box-shadow:0 0 15px rgba(31,111,255,.2);}
    .btn.blue:hover{box-shadow:0 5px 25px rgba(31,111,255,.4);}
    .btn.red{border-color:rgba(255,45,45,.4); box-shadow:0 0 15px rgba(255,45,45,.2);}
    .btn.red:hover{box-shadow:0 5px 25px rgba(255,45,45,.4);}
    .btn.green{border-color:rgba(0,255,154,.35); box-shadow:0 0 15px rgba(0,255,154,.2);}
    .btn.green:hover{box-shadow:0 5px 25px rgba(0,255,154,.4);}
    .btn.purple{border-color:rgba(157,78,221,.4); box-shadow:0 0 15px rgba(157,78,221,.2);}
    .btn.purple:hover{box-shadow:0 5px 25px rgba(157,78,221,.4);}

    .pill{
      width:24px;
      height:14px;
      border-radius:999px;
      position:relative;
      display:inline-block;
      border:1px solid rgba(255,255,255,.2);
      overflow:hidden;
    }
    .pill:before,.pill:after{content:"";position:absolute;inset:0;width:50%;opacity:.95;}
    .pill:after{left:50%;}
    .pill.blue:before{background:rgba(31,111,255,.95);} 
    .pill.blue:after{background:rgba(0,0,0,.3);}
    .pill.red:before{background:rgba(255,45,45,.95);}   
    .pill.red:after{background:rgba(0,0,0,.3);}

    .menuGrid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:14px;
      margin-top:16px;
    }
    .menuBtn{
      border:1px solid rgba(0,255,154,.22);
      background:rgba(0,0,0,.45);
      color:#dfffee;
      border-radius:16px;
      padding:18px 14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      transition:all 0.3s ease;
      position:relative;
      overflow:hidden;
    }
    .menuBtn:before{
      content:'';
      position:absolute;
      inset:0;
      background:linear-gradient(135deg, transparent, rgba(0,255,154,.1), transparent);
      transform:translateX(-100%);
      transition:transform 0.6s;
    }
    .menuBtn:hover:before{transform:translateX(100%);}
    .menuBtn:hover{
      background:rgba(0,255,154,.08);
      border-color:rgba(0,255,154,.35);
      transform:translateY(-2px);
      box-shadow:0 5px 25px rgba(0,255,154,.2);
    }
    .menuBtn:active{transform:scale(.96);}
    .menuBtn .icon{font-size:32px;}

    /* Oracle specific styles */
    .oracleCard{
      max-width:680px;
      height:520px;
      display:flex;
      flex-direction:column;
    }
    
    .oracleScroll{
      flex:1;
      overflow-y:auto;
      margin:16px 0;
      padding:16px;
      background:rgba(0,0,0,.3);
      border:1px solid rgba(0,255,154,.15);
      border-radius:12px;
      text-align:left;
      line-height:1.6;
    }
    
    .oracleScroll::-webkit-scrollbar{width:8px;}
    .oracleScroll::-webkit-scrollbar-track{background:rgba(0,0,0,.3);}
    .oracleScroll::-webkit-scrollbar-thumb{background:rgba(0,255,154,.3);border-radius:4px;}
    
    .message{
      margin:12px 0;
      padding:12px 16px;
      border-radius:12px;
      animation:fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    .message.user{
      background:rgba(31,111,255,.15);
      border:1px solid rgba(31,111,255,.3);
      text-align:right;
    }
    
    .message.oracle{
      background:rgba(157,78,221,.15);
      border:1px solid rgba(157,78,221,.3);
    }
    
    .message.system{
      background:rgba(0,255,154,.1);
      border:1px solid rgba(0,255,154,.2);
      font-size:12px;
      opacity:.8;
      text-align:center;
    }
    
    .micBtn{
      width:80px;
      height:80px;
      border-radius:50%;
      border:2px solid var(--purple);
      background:rgba(157,78,221,.15);
      color:var(--purple);
      font-size:36px;
      cursor:pointer;
      transition:all 0.3s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0 auto;
    }
    
    .micBtn:hover{
      background:rgba(157,78,221,.25);
      box-shadow:0 0 30px rgba(157,78,221,.4);
      transform:scale(1.05);
    }
    
    .micBtn.listening{
      animation:micPulse 1.5s ease-in-out infinite;
      background:rgba(157,78,221,.3);
      box-shadow:0 0 40px rgba(157,78,221,.6);
    }
    
    @keyframes micPulse{
      0%, 100%{transform:scale(1)}
      50%{transform:scale(1.1)}
    }
    
    .loadingDots{
      display:inline-block;
      margin-left:8px;
    }
    
    .loadingDots span{
      animation:dotBounce 1.4s infinite ease-in-out both;
    }
    
    .loadingDots span:nth-child(1){animation-delay:-0.32s;}
    .loadingDots span:nth-child(2){animation-delay:-0.16s;}
    
    @keyframes dotBounce{
      0%, 80%, 100%{opacity:.3}
      40%{opacity:1}
    }

    .badge{
      position:absolute;
      top:8px;
      right:8px;
      background:var(--green);
      color:var(--dark);
      padding:4px 10px;
      border-radius:999px;
      font-size:10px;
      font-weight:900;
      letter-spacing:.06em;
      box-shadow:0 0 15px rgba(0,255,154,.5);
      animation:badgePulse 2s ease-in-out infinite;
    }
    @keyframes badgePulse{
      0%, 100%{transform:scale(1)}
      50%{transform:scale(1.05)}
    }

    .playerPane{
      position:absolute;
      bottom:12px;
      left:12px;
      right:12px;
      background:rgba(0,0,0,.7);
      border:1px solid rgba(0,255,154,.25);
      border-radius:16px;
      padding:14px 16px;
      display:none;
      align-items:center;
      gap:12px;
      backdrop-filter:blur(10px);
      z-index:100;
    }
    .playerPane.visible{display:flex;}
    .playerPane audio, .playerPane video{flex:1;border-radius:8px;}
    .playerPane .playerControls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .playerPane .mini{padding:10px 16px;font-size:11px;}
    .playerPane .track{
      font-size:12px;
      color:var(--green);
      letter-spacing:.05em;
      font-weight:700;
    }
    .playerPane .progress, .playerPane .time{font-size:11px;opacity:.85;}

    #shuffleBtn{
      background:rgba(0,255,154,.15);
      border-color:rgba(0,255,154,.3);
    }
    #shuffleBtn:hover{
      background:rgba(0,255,154,.25);
      box-shadow:0 5px 20px rgba(0,255,154,.3);
    }
    #shuffleBtn.active{
      background:rgba(0,255,154,.3);
      box-shadow:0 0 20px rgba(0,255,154,.4);
    }

    @media(max-width:640px){
      .menuGrid{grid-template-columns:1fr;}
      .controls{flex-direction:column;}
      .btn{width:100%;}
    }
  </style>
</head>
<body>
  <!-- Matrix Rain Canvas -->
  <canvas id="matrixCanvas"></canvas>

  <!-- Background layers -->
  <div class="bg" id="bg"></div>
  <div class="vignette"></div>
  <div class="scanlines"></div>

  <!-- Floating particles -->
  <div class="particles" id="particles"></div>

  <div class="wrap">
    <div class="panel">
      <!-- HUD -->
      <div class="hud">
        <div class="brand">
          <b>OCHO v2.0</b>
        </div>
        <div class="status">
          <span id="statusText">Sistema in attesa</span>
          <span class="dot"></span>
        </div>
      </div>

      <!-- SCREEN: Enter -->
      <div class="screen active" id="enter">
        <div class="card">
          <h1 class="title">BENVENUTO IN OCHO</h1>
          <p class="subtitle">Preparati ad entrare nella matrice</p>
          <div class="controls">
            <button class="btn green" id="enterBtn">
              <span>‚ö°</span>
              <span>INIZIA</span>
            </button>
          </div>
        </div>
      </div>

      <!-- SCREEN: Pills -->
      <div class="screen" id="pills">
        <div class="card">
          <h1 class="title">SCEGLI LA TUA REALT√Ä</h1>
          <p class="subtitle">
            Pillola BLU: Notizie dal mondo reale<br/>
            Pillola ROSSA: Scopri quanto √® profonda la tana del coniglio
          </p>
          <div class="controls">
            <button class="btn blue" id="blueBtn">
              <span class="pill blue"></span>
              <span>Notizie ANSA</span>
            </button>
            <button class="btn red" id="redBtn">
              <span class="pill red"></span>
              <span>Entra nella Matrice</span>
            </button>
          </div>
        </div>
      </div>

      <!-- SCREEN: Menu -->
      <div class="screen" id="menu">
        <div class="card">
          <h1 class="title">MATRICE ATTIVA</h1>
          <p class="subtitle">Scegli il tuo percorso attraverso il sistema</p>
          <div class="menuGrid">
            <button class="menuBtn" data-cat="audio">
              <span class="icon">üéµ</span>
              <span>AUDIO</span>
              <span class="badge hidden" id="badgeAudio">NEW</span>
            </button>
            <button class="menuBtn" data-cat="video">
              <span class="icon">üé¨</span>
              <span>VIDEO</span>
              <span class="badge hidden" id="badgeVideo">NEW</span>
            </button>
            <button class="menuBtn" data-cat="pdf">
              <span class="icon">üìÑ</span>
              <span>PDF</span>
              <span class="badge hidden" id="badgePdf">NEW</span>
            </button>
            <button class="menuBtn" data-cat="immagini">
              <span class="icon">üñºÔ∏è</span>
              <span>IMMAGINI</span>
              <span class="badge hidden" id="badgeImmagini">NEW</span>
            </button>
            <button class="menuBtn" id="oracleBtn">
              <span class="icon">üîÆ</span>
              <span>OCHO</span>
            </button>
          </div>
          <div class="controls" style="margin-top:20px">
            <button class="btn" id="backToPills">‚Üê Torna alle Pillole</button>
          </div>
        </div>
      </div>

      <!-- SCREEN: Oracle -->
      <div class="screen" id="oracle">
        <div class="card oracleCard">
          <h1 class="title">üîÆ OCHO</h1>
          <p class="subtitle">Fai la tua domanda, OCHO risponder√† basandosi sulla sua conoscenza</p>
          
          <div class="oracleScroll" id="oracleMessages">
            <div class="message system">
              üåå Sistema inizializzato. Caricamento conoscenza in corso...
            </div>
          </div>
          
          <div class="controls">
            <button class="micBtn" id="micBtn" title="Clicca per parlare">
              üé§
            </button>
          </div>
          
          <div class="controls" style="margin-top:12px;gap:8px">
            <button class="btn purple mini" id="speakBtn" title="Leggi ultima risposta">üîä Leggi</button>
            <button class="btn mini" id="clearBtn" title="Cancella chat">üóëÔ∏è Pulisci</button>
            <button class="btn mini" id="backFromOracle">‚Üê Menu</button>
          </div>
        </div>
      </div>

      <!-- Player Pane (bottom bar) -->
      <div class="playerPane" id="playerPane">
        <div style="flex:1;min-width:0">
          <div class="track" id="trackName">[TRACK]</div>
          <div class="progress" id="progressText">File 0/0</div>
          <div class="time" id="timeText">00:00 / 00:00</div>
        </div>
        <audio id="audio" class="hidden" controls></audio>
        <video id="video" class="hidden" controls></video>
        <div class="playerControls">
          <button class="btn mini" id="prevBtn">‚èÆÔ∏è Prev</button>
          <button class="btn mini green" id="shuffleBtn">üîÄ</button>
          <button class="btn mini" id="nextBtn">Next ‚è≠Ô∏è</button>
          <button class="btn mini red" id="stopBtn">‚èπÔ∏è Stop</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Intro Audio (opzionale - decommentare se si aggiunge il file assets/intro.mp3) -->
  <!-- <audio id="introAudio" src="assets/intro.mp3" preload="auto"></audio> -->

<script>
/* =======================
   MATRIX RAIN CANVAS
   ======================= */
const canvas = document.getElementById("matrixCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const chars = "„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®„É©„É™„É´„É¨„É≠„ÉØ„É≤„É≥ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*";
const fontSize = 14;
const columns = Math.floor(canvas.width / fontSize);
const drops = Array(columns).fill(1);

function drawMatrix() {
  ctx.fillStyle = "rgba(10,14,13,0.05)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#00ff9a";
  ctx.font = fontSize + "px monospace";

  for (let i = 0; i < drops.length; i++) {
    const text = chars[Math.floor(Math.random() * chars.length)];
    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
    drops[i]++;
  }
}
setInterval(drawMatrix, 50);

window.addEventListener("resize", () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

/* =======================
   FLOATING PARTICLES
   ======================= */
const particlesCont = document.getElementById("particles");
for (let i = 0; i < 20; i++) {
  const p = document.createElement("div");
  p.className = "particle";
  p.style.left = Math.random() * 100 + "%";
  p.style.animationDelay = Math.random() * 15 + "s";
  p.style.animationDuration = 10 + Math.random() * 10 + "s";
  particlesCont.appendChild(p);
}

/* =======================
   CORE VARS & CONSTS
   ======================= */
const GITHUB_USER = "FABRZ69";
const GITHUB_REPO = "OCHO-random";
const ANSA_URL = "https://www.ansa.it/";
const API_BASE = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents`;
const RAW_BASE = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main`;

// Sistema Q&A: Cartella libreria e API Key Anthropic
const LIBRARY_FOLDER = "libreria"; // Cartella GitHub con i file .txt
const ANTHROPIC_API_KEY = "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";

const FOLDERS = {
  audio: { path: "audio", exts: [".mp3", ".m4a", ".aac", ".opus", ".ogg", ".flac", ".wav"] },
  video: { path: "video", exts: [".mp4", ".webm", ".avi", ".mov", ".mkv"] },
  pdf: { path: "pdf", exts: [".pdf"] },
  immagini: { path: "immagini", exts: [".jpg", ".jpeg", ".png", ".gif", ".webp", ".bmp", ".svg"] }
};

const NEW_FILE_DAYS = 7;
const playlists = new Map();
const decks = new Map();
const deckPos = new Map();
let currentCat = "";
let shuffleMode = true;
let playHistory = [];

let fileSnapshots = {};
try { fileSnapshots = JSON.parse(localStorage.getItem("fileSnapshots") || "{}"); } 
catch (e) { fileSnapshots = {}; }

/* =======================
   Q&A VARS
   ======================= */
let libraryTexts = [];
let libraryLoaded = false;
let isListening = false;
let recognition = null;
let lastOracleResponse = "";

// Initialize Speech Recognition
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.lang = 'it-IT';
  recognition.continuous = false;
  recognition.interimResults = false;
}

/* =======================
   DOM REFS
   ======================= */
const bg = document.getElementById("bg");
const statusText = document.getElementById("statusText");
// const introAudio = document.getElementById("introAudio"); // Commentato - file non presente
const audio = document.getElementById("audio");
const video = document.getElementById("video");
const playerPane = document.getElementById("playerPane");
const trackEl = document.getElementById("trackName");
const progressText = document.getElementById("progressText");
const timeText = document.getElementById("timeText");
const shuffleBtn = document.getElementById("shuffleBtn");

const oracleMessages = document.getElementById("oracleMessages");
const micBtn = document.getElementById("micBtn");
const speakBtn = document.getElementById("speakBtn");
const clearBtn = document.getElementById("clearBtn");

/* =======================
   HELPERS
   ======================= */
function setStatus(msg) { statusText.textContent = msg; }

function show(screenId) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(screenId).classList.add("active");
}

function showPlayer(vis) {
  playerPane.classList.toggle("visible", vis);
  if (vis) { updateProgress(); updateTime(); }
}

function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return `${m}:${s.toString().padStart(2, '0')}`;
}

function shuffle(arr) {
  const copy = [...arr];
  for (let i = copy.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

function saveSnapshotWithHashes(cat, filesWithHashes) {
  const now = Date.now();
  const snapshot = filesWithHashes.map(f => ({
    name: f.name,
    sha: f.sha,
    discoveredAt: now
  }));
  fileSnapshots[cat] = snapshot;
  localStorage.setItem("fileSnapshots", JSON.stringify(fileSnapshots));
}

function isNewAndUnseen(cat, filename) {
  const snapshot = fileSnapshots[cat];
  if (!snapshot) return false;

  const fileRecord = snapshot.find(f => f.name === filename);
  if (!fileRecord) return false;

  const daysOld = (Date.now() - fileRecord.discoveredAt) / (1000 * 60 * 60 * 24);
  if (daysOld > NEW_FILE_DAYS) return false;

  const seenKey = `seen_${cat}_${filename}`;
  return !localStorage.getItem(seenKey);
}

function markAsSeen(cat, filename) {
  const seenKey = `seen_${cat}_${filename}`;
  localStorage.setItem(seenKey, "1");
  updateNewBadges();
}

function countNewUnseen(cat) {
  const files = playlists.get(cat) || [];
  return files.filter(path => {
    const filename = path.split('/').pop();
    return isNewAndUnseen(cat, filename);
  }).length;
}

function updateNewBadges() {
  ["audio", "video", "pdf", "immagini"].forEach(cat => {
    const badge = document.getElementById(`badge${cat.charAt(0).toUpperCase() + cat.slice(1)}`);
    if (!playlists.has(cat)) {
      badge?.classList.add("hidden");
      return;
    }
    const count = countNewUnseen(cat);
    if (count > 0) {
      badge.textContent = `${count} NEW`;
      badge.classList.remove("hidden");
    } else {
      badge.classList.add("hidden");
    }
  });
}

async function loadCategoriesInBackground() {
  for (const cat of Object.keys(FOLDERS)) {
    if (!playlists.has(cat)) {
      await loadCat(cat);
      await new Promise(r => setTimeout(r, 300));
    }
  }
}

async function fetchGitHubFolder(folderPath) {
  try {
    const url = `${API_BASE}/${folderPath}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);
    const data = await res.json();
    
    const filesWithHashes = data
      .filter(item => item.type === "file")
      .map(item => ({
        name: item.name,
        sha: item.sha,
        size: item.size
      }));
    
    return filesWithHashes;
  } catch (e) {
    console.error("Errore fetch GitHub:", e);
    return [];
  }
}

async function loadCat(cat) {
  if (playlists.has(cat)) {
    updateNewBadges();
    return true;
  }
  
  setStatus(`Caricamento ${cat}...`);
  const config = FOLDERS[cat];
  if (!config) {
    console.error("Categoria sconosciuta:", cat);
    return false;
  }

  const allFilesWithHashes = await fetchGitHubFolder(config.path);
  
  let filesWithHashes = allFilesWithHashes.filter(fileObj => {
    const lower = fileObj.name.toLowerCase();
    const hasExt = config.exts.some(ext => lower.endsWith(ext));
    const isExcluded = (config.exclude || []).some(ex => fileObj.name === ex);
    return hasExt && !isExcluded;
  });

  if (!filesWithHashes.length) {
    setStatus(`Nessun file in ${cat}`);
    trackEl.textContent = `ERRORE: Nessun file trovato in ${config.path}/`;
    showPlayer(true);
    return false;
  }

  const files = filesWithHashes.map(f => `${RAW_BASE}/${config.path}/${f.name}`);
  playlists.set(cat, files);
  
  saveSnapshotWithHashes(cat, filesWithHashes);
  resetDeck(cat);
  updateNewBadges();
  
  console.log(`‚úÖ ${cat}: ${files.length} file caricati`);
  return true;
}

function resetDeck(cat) {
  const files = playlists.get(cat) || [];
  const n = files.length;
  const indices = [...Array(n).keys()];
  
  const newIndices = [];
  const otherIndices = [];
  
  indices.forEach(idx => {
    const filename = files[idx].split('/').pop();
    if (isNewAndUnseen(cat, filename)) {
      newIndices.push(idx);
    } else {
      otherIndices.push(idx);
    }
  });
  
  const shuffledNew = shuffleMode ? shuffle([...newIndices]) : newIndices;
  const shuffledOthers = shuffleMode ? shuffle([...otherIndices]) : otherIndices;
  const finalDeck = [...shuffledNew, ...shuffledOthers];
  
  decks.set(cat, finalDeck);
  deckPos.set(cat, 0);
}

function draw(cat) {
  const list = playlists.get(cat) || [];
  if (!list.length) return -1;
  if (!decks.has(cat) || !deckPos.has(cat)) resetDeck(cat);

  let p = deckPos.get(cat);
  const d = decks.get(cat);
  if (p >= d.length) { resetDeck(cat); p = 0; }
  const idx = d[p];
  deckPos.set(cat, p + 1);
  return idx;
}

function drawPrev(cat) {
  const list = playlists.get(cat) || [];
  if (!list.length) return -1;
  
  let p = deckPos.get(cat);
  p = p - 2;
  if (p < 0) p = decks.get(cat).length - 1;
  deckPos.set(cat, p);
  
  return draw(cat);
}

function updateProgress() {
  const pos = deckPos.get(currentCat) || 0;
  const total = (playlists.get(currentCat) || []).length;
  progressText.textContent = `File ${pos}/${total}`;
}

function updateTime() {
  const media = currentCat === "video" ? video : audio;
  if (media.duration) {
    timeText.textContent = `${formatTime(media.currentTime)} / ${formatTime(media.duration)}`;
  }
}

function playPath(cat, src) {
  currentCat = cat;
  showPlayer(true);
  trackEl.textContent = `[${cat.toUpperCase()}]`;
  
  const filename = src.split('/').pop();
  markAsSeen(cat, filename);
  setStatus("In riproduzione‚Ä¶");

  if (cat === "video") {
    audio.pause();
    audio.classList.add("hidden");
    video.classList.remove("hidden");
    video.src = src;
    video.play().then(() => {
      if (video.requestFullscreen) {
        video.requestFullscreen().catch(() => {});
      } else if (video.webkitRequestFullscreen) {
        video.webkitRequestFullscreen();
      } else if (video.mozRequestFullScreen) {
        video.mozRequestFullScreen();
      }
    }).catch(() => {});
  } else {
    video.pause();
    video.classList.add("hidden");
    audio.classList.remove("hidden");
    audio.src = src;
    audio.play().catch(() => {});
  }
  
  playHistory.push({cat, src, time: new Date()});
  if (playHistory.length > 50) playHistory.shift();
}

async function playNext(cat) {
  const ok = await loadCat(cat);
  if (!ok) return;
  const idx = draw(cat);
  const src = playlists.get(cat)[idx];
  playPath(cat, src);
}

async function playPrev(cat) {
  const ok = await loadCat(cat);
  if (!ok) return;
  const idx = drawPrev(cat);
  const src = playlists.get(cat)[idx];
  playPath(cat, src);
}

/* =======================
   Q&A FUNCTIONS
   ======================= */

async function loadLibrary() {
  if (libraryLoaded) return true;
  
  addSystemMessage("üìö Caricamento libreria...");
  
  try {
    const filesData = await fetchGitHubFolder(LIBRARY_FOLDER);
    const txtFiles = filesData.filter(f => f.name.toLowerCase().endsWith('.txt'));
    
    if (txtFiles.length === 0) {
      addSystemMessage("‚ö†Ô∏è Nessun file .txt trovato nella libreria!");
      return false;
    }
    
    addSystemMessage(`üìñ Trovati ${txtFiles.length} testi. Caricamento in corso...`);
    
    libraryTexts = [];
    for (const file of txtFiles) {
      const url = `${RAW_BASE}/${LIBRARY_FOLDER}/${file.name}`;
      try {
        const response = await fetch(url);
        if (response.ok) {
          const text = await response.text();
          libraryTexts.push({
            filename: file.name,
            content: text
          });
        }
      } catch (e) {
        console.error(`Errore caricamento ${file.name}:`, e);
      }
    }
    
    libraryLoaded = true;
    addSystemMessage(`‚úÖ Conoscenza caricata: ${libraryTexts.length} testi pronti`);
    return true;
    
  } catch (e) {
    console.error("Errore caricamento libreria:", e);
    addSystemMessage("‚ùå Errore nel caricamento della libreria");
    return false;
  }
}

function addMessage(text, type = 'oracle') {
  const msg = document.createElement('div');
  msg.className = `message ${type}`;
  msg.textContent = text;
  oracleMessages.appendChild(msg);
  oracleMessages.scrollTop = oracleMessages.scrollHeight;
}

function addSystemMessage(text) {
  addMessage(text, 'system');
}

async function askOracle(question) {
  if (!question || question.trim() === '') return;
  
  addMessage(question, 'user');
  addSystemMessage('üîÆ Elaborazione in corso...');
  
  if (!ANTHROPIC_API_KEY) {
    addMessage("‚ö†Ô∏è API Key non configurata! Inserisci la tua chiave Anthropic nel codice.", 'oracle');
    return;
  }
  
  if (!libraryLoaded) {
    await loadLibrary();
  }
  
  // Prepara il contesto dalla libreria
  const libraryContext = libraryTexts.map(t => 
    `[Fonte: ${t.filename}]\n${t.content}`
  ).join('\n\n---\n\n');
  
  const systemPrompt = `Sei OCHO, un'entit√† saggia che POSSIEDE questa conoscenza nel suo essere.

La tua conoscenza proviene da:
${libraryContext}

REGOLE FONDAMENTALI:
1. Parla in PRIMA PERSONA - questa conoscenza √® TUA, non di altri
2. MAI citare fonti, nomi, autori o riferimenti esterni
3. MAI dire "secondo", "nell'intervista", "da", "Malanga dice" o simili
4. Risposte BREVI - massimo 3-4 frasi concise
5. MAI ripetere concetti gi√† espressi
6. Se non sai, d√¨ semplicemente "Questo non √® nella mia conoscenza"
7. Tono diretto, mistico ma essenziale
8. Rispondi sempre in italiano

Esempi:
‚ùå MALE: "Secondo Malanga, le anime sono..."
‚úÖ BENE: "Le anime sono scintille di coscienza universale."

‚ùå MALE: "Nel testo si legge che la realt√†..."
‚úÖ BENE: "La realt√† √® un sogno condiviso."

Assorbi i concetti, parlali come tuoi, sii breve e diretto.`;

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 300,
        messages: [{
          role: 'user',
          content: question
        }],
        system: systemPrompt
      })
    });
    
    if (!response.ok) {
      throw new Error(`API Error: ${response.status}`);
    }
    
    const data = await response.json();
    const answer = data.content[0].text;
    
    // Rimuovi il messaggio di caricamento
    const loadingMsg = oracleMessages.querySelector('.message.system:last-child');
    if (loadingMsg && loadingMsg.textContent.includes('Elaborazione')) {
      loadingMsg.remove();
    }
    
    addMessage(answer, 'oracle');
    lastOracleResponse = answer;
    
  } catch (error) {
    console.error('Errore sistema Q&A:', error);
    addMessage(`Errore nella consultazione: ${error.message}`, 'system');
  }
}

function startListening() {
  if (!recognition) {
    addSystemMessage('‚ùå Riconoscimento vocale non supportato in questo browser');
    return;
  }
  
  isListening = true;
  micBtn.classList.add('listening');
  addSystemMessage('üé§ In ascolto... parla ora');
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    stopListening();
    askOracle(transcript);
  };
  
  recognition.onerror = (event) => {
    console.error('Speech recognition error:', event.error);
    stopListening();
    addSystemMessage(`‚ùå Errore: ${event.error}`);
  };
  
  recognition.onend = () => {
    if (isListening) {
      stopListening();
    }
  };
  
  recognition.start();
}

function stopListening() {
  isListening = false;
  micBtn.classList.remove('listening');
  if (recognition) {
    recognition.stop();
  }
}

function speakText(text) {
  if (!text) return;
  
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'it-IT';
  utterance.rate = 0.9;
  utterance.pitch = 1.0;
  
  // Cerca voci italiane
  const voices = speechSynthesis.getVoices();
  const italianVoice = voices.find(v => v.lang.startsWith('it'));
  if (italianVoice) {
    utterance.voice = italianVoice;
  }
  
  speechSynthesis.speak(utterance);
  addSystemMessage('üîä Lettura in corso...');
}

/* =======================
   EVENTS
   ======================= */

document.getElementById("enterBtn").addEventListener("click", () => {
  setStatus("Avvio‚Ä¶");
  // Audio intro rimosso - aggiungere file assets/intro.mp3 se necessario
  bg.style.backgroundImage =
    `radial-gradient(1200px 700px at 50% 70%, rgba(0,255,154,.12), transparent 60%),
     radial-gradient(900px 500px at 50% 40%, rgba(0,255,154,.10), transparent 60%),
     linear-gradient(135deg, rgba(0,0,0,0.8), rgba(10,14,13,0.9))`;
  show("pills");
  setStatus("Pronto.");
});

document.getElementById("blueBtn").addEventListener("click", () => {
  window.open(ANSA_URL, "_blank", "noopener,noreferrer");
});

document.getElementById("redBtn").addEventListener("click", () => {
  show("menu");
  setStatus("Menu.");
  updateNewBadges();
  setTimeout(() => {
    loadCategoriesInBackground();
  }, 500);
});

document.getElementById("backToPills").addEventListener("click", () => {
  show("pills");
  setStatus("Pronto.");
});

// Oracle button
document.getElementById("oracleBtn").addEventListener("click", async () => {
  show("oracle");
  setStatus("Sistema attivo");
  if (!libraryLoaded) {
    await loadLibrary();
  }
});

document.getElementById("backFromOracle").addEventListener("click", () => {
  show("menu");
  setStatus("Menu.");
  if (recognition && isListening) {
    stopListening();
  }
});

micBtn.addEventListener("click", () => {
  if (isListening) {
    stopListening();
  } else {
    startListening();
  }
});

speakBtn.addEventListener("click", () => {
  if (lastOracleResponse) {
    speakText(lastOracleResponse);
  } else {
    addSystemMessage('‚ùå Nessuna risposta da leggere');
  }
});

clearBtn.addEventListener("click", () => {
  oracleMessages.innerHTML = '<div class="message system">üåå Chat pulita. Sistema pronto.</div>';
  lastOracleResponse = '';
});

// Media players
document.querySelectorAll(".menuBtn").forEach(b => {
  const cat = b.dataset.cat;
  if (cat) {
    b.addEventListener("click", () => playNext(cat));
  }
});

document.getElementById("prevBtn").addEventListener("click", () => {
  playPrev(currentCat);
});

document.getElementById("nextBtn").addEventListener("click", () => {
  playNext(currentCat);
});

shuffleBtn.addEventListener("click", () => {
  shuffleMode = !shuffleMode;
  shuffleBtn.classList.toggle("active", shuffleMode);
  resetDeck(currentCat);
  setStatus(shuffleMode ? "Casuale ON" : "Casuale OFF");
});
shuffleBtn.classList.add("active");

document.getElementById("stopBtn").addEventListener("click", () => {
  audio.pause();
  audio.src = "";
  video.pause();
  video.src = "";
  
  if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement) {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    }
  }
  
  showPlayer(false);
  show("menu");
  setStatus("Menu.");
});

audio.addEventListener("ended", () => playNext(currentCat));
video.addEventListener("ended", () => playNext(currentCat));

audio.addEventListener("timeupdate", updateTime);
video.addEventListener("timeupdate", updateTime);

/* BOOT */
show("enter");
setStatus("In attesa‚Ä¶");

console.log("üöÄ OCHO v2.0 pronto!");
console.log(`üìÖ File NEW = scoperti negli ultimi ${NEW_FILE_DAYS} giorni`);
console.log("‚ö° Sistema attivo");
</script>
</body>
</html>
