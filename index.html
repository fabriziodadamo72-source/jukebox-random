<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OCHO • Random Jukebox</title>

<style>
html,body{
  margin:0;height:100%;background:#000;color:#eafff6;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}
.bg{
  position:fixed;inset:0;
  background:url("matrix.jpg") center/cover no-repeat;
}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.45)}
.panel{
  position:relative;height:100%;
  display:flex;align-items:center;justify-content:center;
}
.card{
  background:rgba(0,0,0,.55);
  border:1px solid rgba(0,255,154,.3);
  border-radius:18px;padding:24px;
  text-align:center;max-width:720px;width:90%;
}
h1{margin:0 0 10px;letter-spacing:.1em}
p{font-size:13px;opacity:.9}

.controls,.menu{
  display:flex;gap:14px;justify-content:center;margin-top:20px;
}
button{
  cursor:pointer;border-radius:14px;
  border:1px solid rgba(255,255,255,.2);
  background:rgba(0,0,0,.6);
  color:#fff;padding:12px 18px;
  font-weight:700;letter-spacing:.06em;
}
.red{border-color:#ff2d2d}
.blue{border-color:#1f6fff}

.hidden{display:none}

.player{
  position:fixed;left:50%;bottom:18px;
  transform:translateX(-50%);
  width:90%;max-width:720px;
  background:rgba(0,0,0,.6);
  border:1px solid rgba(0,255,154,.3);
  border-radius:14px;padding:10px;
}
.track{font-size:12px;margin-bottom:6px;opacity:.9}
video,audio{width:100%}
</style>
</head>

<body>
<div class="bg"></div>
<div class="overlay"></div>

<div class="panel">
  <!-- HOME -->
  <div class="card" id="home">
    <h1>SCEGLI LA PILLola</h1>
    <p>Pillola blu: ascolta.<br>Pillola rossa: entra nel Paese delle Meraviglie.</p>
    <div class="controls">
      <button class="blue" id="blueBtn">Pillola Blu</button>
      <button class="red" id="redBtn">Pillola Rossa</button>
    </div>
  </div>

  <!-- RED MENU -->
  <div class="card hidden" id="menu">
    <h1>PAESE DELLE MERAVIGLIE</h1>
    <p>Random senza ripetizioni</p>
    <div class="menu">
      <button data-cat="mp3">MP3</button>
      <button data-cat="song">SONG</button>
      <button data-cat="broadcast">BROADCAST</button>
      <button data-cat="video">VIDEO</button>
    </div>
    <div style="margin-top:14px">
      <button id="back">← Torna</button>
    </div>
  </div>
</div>

<!-- PLAYER -->
<div class="player hidden" id="player">
  <div class="track" id="track">—</div>
  <audio id="audio" controls></audio>
  <video id="video" controls class="hidden"></video>
</div>

<script>
/* ===== CONFIG ===== */
const SOURCES = {
  mp3: "content/mp3.json",
  song: "content/song.json",
  broadcast: "content/broadcast.json",
  video: "content/video.json"
};

/* ===== STATE ===== */
const playlists = {};
const decks = {};
const pos = {};
let currentCat = "mp3";

/* ===== ELEMENTS ===== */
const home = document.getElementById("home");
const menu = document.getElementById("menu");
const player = document.getElementById("player");
const track = document.getElementById("track");
const audio = document.getElementById("audio");
const video = document.getElementById("video");

/* ===== UTILS ===== */
const shuffle = a => {
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
};

async function loadCat(cat){
  if(playlists[cat]) return;
  const r = await fetch(SOURCES[cat],{cache:"no-store"});
  const j = await r.json();
  playlists[cat]=j.files;
  decks[cat]=shuffle([...Array(j.files.length).keys()]);
  pos[cat]=0;
}

function nextIndex(cat){
  if(pos[cat]>=decks[cat].length){
    decks[cat]=shuffle(decks[cat]);
    pos[cat]=0;
  }
  return decks[cat][pos[cat]++];
}

async function play(cat){
  await loadCat(cat);
  currentCat=cat;
  const i=nextIndex(cat);
  const src=playlists[cat][i];
  track.textContent=`[${cat.toUpperCase()}] ${src.split("/").pop()}`;
  player.classList.remove("hidden");

  if(cat==="video"){
    audio.pause(); audio.classList.add("hidden");
    video.src=src; video.classList.remove("hidden"); video.play();
  }else{
    video.pause(); video.classList.add("hidden");
    audio.src=src; audio.classList.remove("hidden"); audio.play();
  }
}

/* ===== EVENTS ===== */
document.getElementById("blueBtn").onclick=()=>play("mp3");
document.getElementById("redBtn").onclick=()=>{
  home.classList.add("hidden");
  menu.classList.remove("hidden");
};

document.getElementById("back").onclick=()=>{
  menu.classList.add("hidden");
  home.classList.remove("hidden");
};

document.querySelectorAll("[data-cat]").forEach(b=>{
  b.onclick=()=>play(b.dataset.cat);
});

audio.onended=()=>play(currentCat);
video.onended=()=>play(currentCat);
</script>
</body>
</html>
